

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>celeris.solver &mdash; CelerisAi 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CelerisAi
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Celeris Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CelerisAi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">celeris.solver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for celeris.solver</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">clr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">griddata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">taichi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ti</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">taichi.math</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celeris.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reconstruct</span><span class="p">,</span><span class="n">CalcUV</span><span class="p">,</span><span class="n">sineWave</span><span class="p">,</span><span class="n">CalcUV_Sed</span><span class="p">,</span><span class="n">CalcUV_Sed</span><span class="p">,</span><span class="n">NumericalFlux</span><span class="p">,</span><span class="n">FrictionCalc</span><span class="p">,</span><span class="n">cosh</span>

<span class="k">def</span><span class="w"> </span><span class="nf">checjson</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a key exists in a JSON config file (i.e., CelerisWebGPU configuration file).</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): The key to check in the JSON config file.</span>
<span class="sd">        config (dict): The JSON-loaded dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: 1 if the key is found in the JSON dictionary, 0 otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">R</span>


<div class="viewcode-block" id="SedClass">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.SedClass">[docs]</a>
<span class="nd">@ti</span><span class="o">.</span><span class="n">data_oriented</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SedClass</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">d50</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>
                 <span class="n">p</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                 <span class="n">psi</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                 <span class="n">CriticalShields</span> <span class="o">=</span><span class="mf">0.045</span><span class="p">,</span>
                 <span class="n">rhorat</span> <span class="o">=</span><span class="mf">2.65</span>
                <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d50</span> <span class="o">=</span> <span class="n">d50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CriticalShields</span> <span class="o">=</span> <span class="n">CriticalShields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhorat</span> <span class="o">=</span> <span class="n">rhorat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Shields</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhorat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">9.81</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d50</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_erosion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">*</span><span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d50</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_settling</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="mf">9.81</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d50</span><span class="o">/</span><span class="mf">1000.</span> <span class="o">/</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhorat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_rho_sat</span> <span class="o">=</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhorat</span><span class="o">*</span><span class="p">(</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="p">))</span><span class="o">/</span><span class="mf">1000.</span></div>


<span class="n">sediment_default</span> <span class="o">=</span> <span class="n">SedClass</span><span class="p">()</span> <span class="c1"># Check this implementation</span>

<div class="viewcode-block" id="Solver">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver">[docs]</a>
<span class="nd">@ti</span><span class="o">.</span><span class="n">data_oriented</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Solver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main numerical solver class for the CelerisAi model.</span>

<span class="sd">    This class manages the entire simulation process, including:</span>
<span class="sd">        - Initializing solution states and bottom fields from the `Domain` class.</span>
<span class="sd">        - Controlling boundary conditions from the `BoundaryConditions` class.</span>
<span class="sd">        - Executing the time-stepping scheme (Euler, Adams-Bashforth variants) and </span>
<span class="sd">          1D/2D flow updates (SWE or Boussinesq).</span>
<span class="sd">        - Incorporating breaking models, sediment transport, and the </span>
<span class="sd">          kernels for reconstruction (Pass1), flux computations (Pass2), </span>
<span class="sd">          and final updates (Pass3).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        domain (Domain): Instance of the Domain class containing grid info and topography.</span>
<span class="sd">        bc (BoundaryConditions): Instance managing boundary condition types and wave settings.</span>
<span class="sd">        dissipation_threshold (float): Used for visualization (mark cells above certain foam/dissipation).</span>
<span class="sd">        theta (float): Midmod limiter parameter (1.0 more dissipative, 2.0 less dissipative).</span>
<span class="sd">        timeScheme (int): Time integration scheme:</span>
<span class="sd">            - 0 =&gt; Euler</span>
<span class="sd">            - 1 =&gt; 3rd-order  predictor</span>
<span class="sd">            - 2 =&gt; 4th-order  predictor/corrector</span>
<span class="sd">        pred_or_corrector (int): Indicates stage in solver loop (1 =&gt; predictor, 2 =&gt; corrector).</span>
<span class="sd">        Bcoef (float): Dispersion parameter for Boussinesq model; default 1/15.</span>
<span class="sd">        model (str): Type of model, &#39;SWE&#39; or &#39;Bouss&#39;.</span>
<span class="sd">        useBreakingModel (bool): True if wave-breaking model is included.</span>
<span class="sd">        whiteWaterDecayRate (float): Turbulence decay rate for foam (visualization).</span>
<span class="sd">        whiteWaterDispersion (float): Turbulence dispersion factor.</span>
<span class="sd">        useSedTransModel (bool): True if sediment transport is included.</span>
<span class="sd">        sediment (object): Default or custom sediment parameters.</span>
<span class="sd">        infiltrationRate (float): For modeling infiltration on dry beaches.</span>
<span class="sd">        clearCon (int): If 1, concentration channel is cleared for visualization.</span>
<span class="sd">        showBreaking (int): If &gt; 0, shows wave breaking foam areas.</span>
<span class="sd">        delta_breaking (float): Eddy viscosity coefficient in breaking zones.</span>
<span class="sd">        T_star_coef (float): Timescale factor for fully developed breaking.</span>
<span class="sd">        dzdt_I_coef (float): Start-breaking parameter threshold.</span>
<span class="sd">        dzdt_F_coef (float): End-breaking parameter threshold.</span>

<span class="sd">    The class initializes a large set of Taichi vector fields (state vectors, flux arrays, </span>
<span class="sd">    intermediate arrays for Boussinesq tridiagonal solves, sediment transport arrays, etc.)</span>
<span class="sd">    to manage the numerical solution.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; solver = Solver(domain=dom, boundary_conditions=bc, model=&#39;SWE&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">boundary_conditions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">dissipation_threshold</span><span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
                 <span class="n">theta</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">timeScheme</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                 <span class="n">pred_or_corrector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">show_window</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">maxsteps</span><span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                 <span class="n">Bcoef</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">15.0</span><span class="p">,</span>
                 <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;SWE&#39;</span><span class="p">,</span>
                 <span class="n">useBreakingModel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">whiteWaterDecayRate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">whiteWaterDispersion</span> <span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">useSedTransModel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">sediment</span><span class="o">=</span><span class="n">sediment_default</span><span class="p">,</span>
                 <span class="n">infiltrationRate</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
                 <span class="n">clearCon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">showBreaking</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">delta_breaking</span><span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">T_star_coef</span><span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                 <span class="n">dzdt_I_coef</span><span class="o">=</span> <span class="mf">0.50</span><span class="p">,</span>
                 <span class="n">dzdt_F_coef</span><span class="o">=</span> <span class="mf">0.15</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Solver with domain and boundary-condition data and sets parameters </span>
<span class="sd">        for the numerical schemes, wave-breaking models, and sediment transport.</span>

<span class="sd">        Args:</span>
<span class="sd">            domain (Domain, optional): Domain object describing the computational grid </span>
<span class="sd">                and topography. Defaults to None.</span>
<span class="sd">            boundary_conditions (BoundaryConditions, optional): Object managing all boundary settings. </span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            dissipation_threshold (float, optional): Threshold for visualization of dissipative zones. </span>
<span class="sd">                Defaults to 0.3.</span>
<span class="sd">            theta (float, optional): Midmod limiter parameter (1.0 =&gt; upwind to 2.0 =&gt; centered). </span>
<span class="sd">                Defaults to 2.0.</span>
<span class="sd">            timeScheme (int, optional): Time integration choice (0 =&gt; Euler, 1 =&gt; 3rd-order AB, </span>
<span class="sd">                2 =&gt; 4th-order AB predictor/corrector). Defaults to 2.</span>
<span class="sd">            pred_or_corrector (int, optional): Indicates current stage in predictor-corrector approach </span>
<span class="sd">                (1 =&gt; predictor, 2 =&gt; corrector). Defaults to 1.</span>
<span class="sd">            show_window (bool, optional): If True, enables visualization window. Defaults to True.</span>
<span class="sd">            maxsteps (int, optional): Max number of time steps to run. Defaults to 1000.</span>
<span class="sd">            Bcoef (float, optional): Dispersion parameter (1/15 for this Boussinesq equations). Defaults to 1.0/15.0.</span>
<span class="sd">            outdir (str, optional): Output directory for results. Defaults to None.</span>
<span class="sd">            model (str, optional): Model type (&#39;SWE&#39; or &#39;Bouss&#39;). Defaults to &#39;SWE&#39;.</span>
<span class="sd">            useBreakingModel (bool, optional): Enables wave-breaking model if True. Defaults to False.</span>
<span class="sd">            whiteWaterDecayRate (float, optional): Turbulent foam decay rate. Defaults to 0.01.</span>
<span class="sd">            whiteWaterDispersion (float, optional): Turbulent foam dispersion. Defaults to 0.1.</span>
<span class="sd">            useSedTransModel (bool, optional): Enables sediment transport if True. Defaults to False.</span>
<span class="sd">            sediment (object, optional): Sediment parameter object. Defaults to None.</span>
<span class="sd">            infiltrationRate (float, optional): Dry-beach infiltration rate. Defaults to 0.001.</span>
<span class="sd">            clearCon (int, optional): Clears concentration channel if == 1. Defaults to 1.</span>
<span class="sd">            showBreaking (int, optional): If &gt; 0, show wave breaking areas as foam. Defaults to 0.</span>
<span class="sd">            delta_breaking (float, optional): Eddy viscosity coefficient for breaking. Defaults to 2.0.</span>
<span class="sd">            T_star_coef (float, optional): Timescale factor until breaking fully develops. Defaults to 5.0.</span>
<span class="sd">            dzdt_I_coef (float, optional): Start-breaking threshold. Defaults to 0.50.</span>
<span class="sd">            dzdt_F_coef (float, optional): End-breaking threshold. Defaults to 0.15.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span>  <span class="o">=</span> <span class="n">boundary_conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useSedTransModel</span> <span class="o">=</span> <span class="n">useSedTransModel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearConc</span> <span class="o">=</span> <span class="n">clearCon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span>                  <span class="c1"># Bottom [BN, BE, B, Dry/Wet] # B-&gt;bottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">precision</span>
        <span class="c1">#self.temp_bottom = self.domain.bottom()</span>
        <span class="c1"># Physical &quot;state&quot; values, eval at center of cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                   <span class="c1"># stores the state[eta, P, Q, hc] at t = n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                <span class="c1"># stores the state[eta, P, Q, hc] at t = n + 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BottomFriction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateUVstar</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>              <span class="c1"># the values of the current (n) bous-grouped state, or eta, U, V, and c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>      <span class="c1"># next bous-grouped state</span>
        <span class="c1"># State variables, texture gives values along cell edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Hnear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                   <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                       <span class="c1"># water depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                       <span class="c1"># E-W velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                       <span class="c1"># N-S velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                       <span class="c1"># Scalar concentration</span>
        <span class="c1"># Advective flux vectors F(U)-x - G(U)-y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                   <span class="c1"># stores x-flux values along cell edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                   <span class="c1"># stores y-flux values along cell edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldGradients</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>             <span class="c1"># stores d(state)/dt values at previous time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldOldGradients</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>          <span class="c1"># stores d(state)/dt values from two time steps ago</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictedGradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>      <span class="c1"># stores d(state)/dt values found in the predictor step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                <span class="c1"># stores d(state)/dt values output from Pass3 calls - Posible can be replaced by self.predictedGradients</span>

        <span class="c1"># Bouss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>           <span class="c1"># stores F*, G* (bous only) found in predictor step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_G_star_oldGradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>       <span class="c1"># stores F*, G* (bous only) found at previous time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_G_star_oldOldGradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>    <span class="c1"># stores F*, G* (bous only) found from two time steps ago</span>
        <span class="c1"># Parallel Cyclic Reduction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                    <span class="c1"># tridiagonal coefficients for x-dir (bous only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                    <span class="c1"># tridiagonal coefficients for y-dir (bous only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>               <span class="c1"># temp storage for PCR x-dir PCR reduced tridiagonal coefficients for x-dir (bous only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>               <span class="c1"># temp storage for PCR y-dir PCR reduced tridiagonal coefficients for y-dir (bous only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>               <span class="c1"># temp storage for PCR x-dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRy2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>               <span class="c1"># temp storage for PCR y-dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp2_PCRx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>              <span class="c1"># temp storage for P solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp2_PCRy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>              <span class="c1"># temp storage for Q solution</span>

        <span class="c1"># Sediment Transport Vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span>  <span class="o">=</span> <span class="n">sediment</span>                           <span class="c1"># Sediment parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>                   <span class="c1"># State of sediment class at edges [4,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XFlux_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># Flux sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">YFlux_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># Flux sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NewState_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldGradients_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldOldGradients_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictedGradients_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">erosion_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deposition_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>           <span class="c1"># State of sediment class [1,nx,ny]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">infiltrationRate</span> <span class="o">=</span> <span class="n">infiltrationRate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">=</span> <span class="n">showBreaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ContSource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states_one</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">states</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">reflect_x</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_y</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">reflect_y</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">Boundary_shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BoundaryNy</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">Ny</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BoundaryNx</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">Nx</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nSL</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">north_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sSL</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">south_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eSL</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">east_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wSL</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">west_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seaLevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">seaLevel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">maxdepth</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxtopo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">maxtopo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WaveData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nwaves</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">N_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_eta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">init_eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useBreakingModel</span> <span class="o">=</span> <span class="n">useBreakingModel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dissipation_threshold</span> <span class="o">=</span> <span class="n">dissipation_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDecayRate</span> <span class="o">=</span> <span class="n">whiteWaterDecayRate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span> <span class="o">=</span> <span class="n">whiteWaterDispersion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_breaking</span> <span class="o">=</span> <span class="n">delta_breaking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span>    <span class="o">=</span> <span class="n">theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">0.005</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span> <span class="o">/</span> <span class="mf">5000.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>  <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">dt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">isManning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">friction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span> <span class="o">=</span> <span class="n">timeScheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_or_corrector</span> <span class="o">=</span> <span class="n">pred_or_corrector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">Nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">Ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_window</span> <span class="o">=</span> <span class="n">show_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsteps</span><span class="o">=</span><span class="n">maxsteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">=</span> <span class="n">Bcoef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Py</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="c1"># Model parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="c1"># Boundary conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcNorth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">North</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcSouth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">South</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcEast</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">East</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcWest</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">West</span>
        <span class="c1"># Breaking parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_star_coef</span> <span class="o">=</span> <span class="n">T_star_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_F_coef</span> <span class="o">=</span> <span class="n">dzdt_F_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_I_coef</span> <span class="o">=</span> <span class="n">dzdt_I_coef</span>

        <span class="c1"># If using celeris-type config, override some parameters from JSON if present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">celeris</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;whiteWaterDecayRate&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDecayRate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;whiteWaterDecayRate&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDecayRate</span> <span class="o">=</span> <span class="n">whiteWaterDecayRate</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;whiteWaterDispersion&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;whiteWaterDispersion&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span> <span class="o">=</span> <span class="n">whiteWaterDispersion</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;dissipation_threshold&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dissipation_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;dissipation_threshold&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dissipation_threshold</span> <span class="o">=</span> <span class="n">dissipation_threshold</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;delta_breaking&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta_breaking</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;delta_breaking&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta_breaking</span> <span class="o">=</span> <span class="n">delta_breaking</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;Theta&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;Theta&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;Bcoef&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;Bcoef&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">=</span> <span class="n">Bcoef</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">dt</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;timeScheme&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;timeScheme&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;delta&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">0.005</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span> <span class="o">/</span> <span class="mf">5000.0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;epsilon&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>  <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;Px&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;Px&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;Py&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Py</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;Py&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Py</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;friction&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;friction&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">friction</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;useBreakingModel&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">useBreakingModel</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;useBreakingModel&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">useBreakingModel</span> <span class="o">=</span> <span class="n">useBreakingModel</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;T_star_coef&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># defines length of time until breaking becomes fully developed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_star_coef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;T_star_coef&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">T_star_coef</span> <span class="o">=</span> <span class="n">T_star_coef</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;dzdt_I_coef&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># start breaking parameter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_I_coef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;dzdt_I_coef&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_I_coef</span> <span class="o">=</span> <span class="n">dzdt_I_coef</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;dzdt_F_coef&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># end breaking parameter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_F_coef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;dzdt_F_coef&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_F_coef</span> <span class="o">=</span> <span class="n">dzdt_F_coef</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;useSedTransModel&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">useSedTransModel</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;useSedTransModel&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">useSedTransModel</span> <span class="o">=</span> <span class="n">useSedTransModel</span>

            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;NLSW_or_Bous&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># end breaking parameter</span>
                <span class="n">modelo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;NLSW_or_Bous&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">modelo</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;Bouss&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;SWE&#39;</span>
            <span class="c1"># If using sediment model, update sediment parameters from JSON</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useSedTransModel</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;sedC1_d50&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">d50</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;sedC1_d50&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;sedC1_n&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;sedC1_n&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;sedC1_psi&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;sedC1_psi&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;sedC1_criticalshields&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">CriticalShields</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;sedC1_criticalshields&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;sedC1_denrat&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">rhorat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;sedC1_denrat&#39;</span><span class="p">])</span>
                <span class="c1"># Sediment parameters must be computed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">Shields</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">rhorat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">9.81</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">d50</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">C_erosion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">psi</span><span class="o">*</span><span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">d50</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">C_settling</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="mf">9.81</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">d50</span><span class="o">/</span><span class="mf">1000.</span> <span class="o">/</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">rhorat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">C_rho_sat</span> <span class="o">=</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">p</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">rhorat</span><span class="o">*</span><span class="p">(</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">p</span> <span class="p">))</span><span class="o">/</span><span class="mf">1000.</span>



        <span class="c1"># COMPUTATION OF PARAMETERS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">double_dx</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">double_dy</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dxdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d3x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d3y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">two_theta</span> <span class="o">=</span>  <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">half_g</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span>

<div class="viewcode-block" id="Solver.InitStates">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.InitStates">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">InitStates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the solver states (State, stateUVstar) to zeros at the start </span>
<span class="sd">        of the simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">50000.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="Solver.fill_bottom_field">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.fill_bottom_field">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fill_bottom_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills the bottom vector field array with computed spatial derivatives (indices 0,1)</span>
<span class="sd">        and near-dry/auxiliary flags at index 3. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lengthCheck</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">ti</span><span class="o">.</span><span class="n">ndrange</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="c1"># BE</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">99.0</span>
                <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">lengthCheck</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">lengthCheck</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">xC</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xx</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">xC</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">ti</span><span class="o">.</span><span class="n">ndrange</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span> <span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="c1"># BN</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="c1"># BE</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">99.0</span>
                <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">lengthCheck</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">lengthCheck</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">ti</span><span class="o">.</span><span class="n">loop_config</span><span class="p">(</span><span class="n">serialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">lengthCheck</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">lengthCheck</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">xC</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xx</span><span class="p">))</span>
                        <span class="n">yC</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">yy</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">xC</span><span class="p">,</span><span class="n">yC</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.0</span></div>


<div class="viewcode-block" id="Solver.BoundSineWaves">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.BoundSineWaves">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">func</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">BoundSineWaves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">NumWaves</span><span class="p">,</span><span class="n">Waves</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="n">grav</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes boundary conditions for incoming sine waves at a domain boundary.</span>

<span class="sd">        Args:</span>
<span class="sd">            NumWaves (int): Number of wave components in `Waves`.</span>
<span class="sd">            Waves (ti.field): Wave parameter array [numWaves, 4].</span>
<span class="sd">            x (float): x-coordinate at boundary cell.</span>
<span class="sd">            y (float): y-coordinate at boundary cell.</span>
<span class="sd">            t (float): Current time.</span>
<span class="sd">            d_here (float): Local water depth if positive; 0 if dry.</span>
<span class="sd">            grav (float): Gravity constant.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ti.types.vector(3, float): [eta, hu, hv] aggregated from all wave components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">grav</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">grav</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d_here</span><span class="o">&gt;</span><span class="mf">0.0001</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NumWaves</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">sineWave</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">Waves</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">Waves</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">Waves</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">Waves</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="mi">3</span><span class="p">]),</span><span class="n">grav</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="Solver.SolitaryWave">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.SolitaryWave">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">func</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">SolitaryWave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">d_here</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes boundary conditions for a solitary wave type (WaveType=3).</span>

<span class="sd">        Args:</span>
<span class="sd">            x0 (float): Initial x-position of the wave crest.</span>
<span class="sd">            y0 (float): Initial y-position of the wave crest.</span>
<span class="sd">            theta (float): Wave propagation angle in radians.</span>
<span class="sd">            x (float): x-coordinate at boundary cell.</span>
<span class="sd">            y (float): y-coordinate at boundary cell.</span>
<span class="sd">            t (float): Current simulation time.</span>
<span class="sd">            d_here (float): Local water depth, if any.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple of (float, float, float): (eta, hu, hv) for a solitary wave boundary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">amplitude</span>
        <span class="n">xloc</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x0</span>
        <span class="n">yloc</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y0</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span><span class="o">/</span><span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">d_here</span><span class="p">,</span><span class="mf">3.0</span><span class="p">))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">amp</span> <span class="o">+</span> <span class="n">d_here</span><span class="p">))</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span> <span class="n">cosh</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">xloc</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">yloc</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">t</span><span class="p">))</span> <span class="p">,</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">hu</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">amp</span> <span class="o">/</span> <span class="n">d_here</span><span class="p">)</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">hv</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">amp</span> <span class="o">/</span> <span class="n">d_here</span><span class="p">)</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span></div>


<div class="viewcode-block" id="Solver.BoundaryPass">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.BoundaryPass">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">BoundaryPass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="p">:</span><span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">,</span> <span class="n">txState</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates boundary cells with the appropriate boundary conditions:</span>
<span class="sd">          - Sponge layers (type=1) </span>
<span class="sd">          - Solid walls (type=0)</span>
<span class="sd">          - Incoming waves (type=2) including sine wave or solitary wave</span>

<span class="sd">        This kernel is also responsible for handling near-dry logic and simple </span>
<span class="sd">        wetting/drying checks at the domain edges. </span>

<span class="sd">        Args:</span>
<span class="sd">            time (float): Current time.</span>
<span class="sd">            txState (ti.field): A Taichi 2D vector field for the state to be updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check 1D</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">ti</span><span class="o">.</span><span class="n">ndrange</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)):</span>
                <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">BCState_Sed</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="c1">### SPONGE LAYERS</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcWest</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="p">):</span>
                    <span class="n">gamma</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span> <span class="mf">0.005</span><span class="p">)</span>
                    <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                    <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcEast</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
                    <span class="n">gamma</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundaryNx</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span> <span class="mf">0.005</span><span class="p">)</span>
                    <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                    <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c1">### SOLID WALLS</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcWest</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span>  <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">txState</span><span class="p">[</span>  <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span>  <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcEast</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">txState</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c1">### INCOMING WALLS</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcWest</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">B_here</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">bcwave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundSineWaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nwaves</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">WaveData</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_g</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wSL</span><span class="p">,</span> <span class="n">bcwave</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span> <span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSL</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SolitaryWave</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">d_here</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">eta</span> <span class="p">,</span> <span class="n">hu</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcEast</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">B_here</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">bcwave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundSineWaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nwaves</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">WaveData</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_g</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span>  <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eSL</span><span class="p">,</span> <span class="n">bcwave</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSL</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.1415</span>
                        <span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SolitaryWave</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">d_here</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">eta</span> <span class="p">,</span> <span class="n">hu</span> <span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1">#Compute the coordinates of the neighbors</span>
                <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span> <span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">B_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">state_west</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">state_east</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">eta_here</span> <span class="o">=</span>  <span class="n">BCState</span><span class="o">.</span><span class="n">x</span> <span class="c1">#</span>
                <span class="n">eta_west</span> <span class="o">=</span> <span class="n">state_west</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_east</span> <span class="o">=</span> <span class="n">state_east</span><span class="o">.</span><span class="n">x</span>

                <span class="n">h_here</span>  <span class="o">=</span> <span class="n">eta_here</span> <span class="o">-</span> <span class="n">B_here</span> <span class="c1"># CHANGE</span>
                <span class="n">h_west</span> <span class="o">=</span> <span class="n">eta_west</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">eta_east</span> <span class="o">-</span> <span class="n">B_east</span>

                <span class="n">h_cut</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">h_cut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span><span class="o">-</span><span class="n">B_east</span><span class="p">))</span>
                <span class="n">h_cut</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span><span class="o">-</span><span class="n">B_west</span><span class="p">))</span>

                <span class="n">dry_here</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dry_west</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dry_east</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">h_here</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                    <span class="n">dry_here</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">h_west</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="o">.</span><span class="n">w</span><span class="p">:</span>
                    <span class="n">dry_west</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">h_east</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
                    <span class="n">dry_east</span><span class="o">=</span><span class="mi">0</span>

                <span class="c1">#sum_dry = dry_west + dry_east</span>

                <span class="n">h_min</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span><span class="n">h_east</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span><span class="n">h_west</span><span class="p">)</span>

                <span class="c1">#wetdry = ti.min(h_here, ti.min(h_south, ti.min(h_north, ti.min(h_west, h_east))))</span>
                <span class="c1">#nearshore = ti.min(B_here, ti.min(B_south, ti.min(B_north, ti.min(B_west, B_east))))</span>

                <span class="c1"># Remove islands</span>
                <span class="c1">#if dry_here==1:</span>
                <span class="c1">#    if sum_dry==0:</span>
                <span class="c1">#        if (B_here&lt;=0.0):</span>
                <span class="c1">#            BCState = ti.Vector([ti.max(BCState.x , B_here), 0.0, 0.0, 0.0],self.precision)</span>
                <span class="c1">#            BCState_Sed = 0.0</span>
                <span class="c1">#        else:</span>
                <span class="c1">#            BCState = ti.Vector([B_here,0.0,0.0,0.0],self.precision)</span>
                <span class="c1">#            BCState_Sed = 0.0</span>
                <span class="c1">#    elif sum_dry==1:</span>
                <span class="c1">#        wet_eta = (float(dry_west)*eta_west + float(dry_east)*eta_east)/float(sum_dry)</span>
                <span class="c1">#        BCState = ti.Vector([wet_eta,0.0,0.0,0.0],self.precision)</span>
                <span class="c1">#        BCState_Sed = 0.0</span>
                
                <span class="c1"># Check for negative depths</span>
                <span class="n">h_here</span> <span class="o">=</span> <span class="n">BCState</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">B_here</span>  <span class="c1"># To change</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">h_here</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">B_here</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">):</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">BCState</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">B_here</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">B_here</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">BCState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NewState_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">BCState_Sed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#for i,j in txState:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">ti</span><span class="o">.</span><span class="n">ndrange</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)):</span>
                <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">BCState_Sed</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="c1">### SPONGE LAYERS</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcWest</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="p">):</span>
                    <span class="n">gamma</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span> <span class="mf">0.005</span><span class="p">)</span>
                    <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                    <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcEast</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
                    <span class="n">gamma</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundaryNx</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span> <span class="mf">0.005</span><span class="p">)</span>
                    <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                    <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcSouth</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="p">):</span>
                    <span class="n">gamma</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="n">j</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span> <span class="mf">0.005</span><span class="p">)</span>
                    <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                    <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bcNorth</span> <span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">gamma</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BoundaryNy</span> <span class="o">-</span> <span class="n">j</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span> <span class="mf">0.005</span><span class="p">)</span>
                    <span class="n">BCState</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                    <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c1">### SOLID WALLS</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcWest</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span>  <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">txState</span><span class="p">[</span>  <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span>  <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span>  <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcEast</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">txState</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcSouth</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BCShift</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcNorth</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_y</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_y</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_y</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_y</span> <span class="o">-</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">j</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">BCState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c1">### INCOMING WALLS</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcWest</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">B_here</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
                        <span class="n">bcwave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundSineWaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nwaves</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">WaveData</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_g</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wSL</span><span class="p">,</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wSL</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span> <span class="c1"># Shift in X</span>
                        <span class="n">y0</span> <span class="o">=</span>   <span class="mf">0.0</span>
                        <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SolitaryWave</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">d_here</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcEast</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">B_here</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
                        <span class="n">bcwave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundSineWaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nwaves</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">WaveData</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_g</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span>  <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eSL</span><span class="p">,</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eSL</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.1415</span>
                        <span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SolitaryWave</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">d_here</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcSouth</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">B_here</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
                        <span class="n">bcwave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundSineWaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nwaves</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">WaveData</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_g</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sSL</span><span class="p">,</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSL</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">y0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">theta</span> <span class="o">=</span> <span class="mf">3.1415</span> <span class="o">/</span> <span class="mf">2.0</span>
                        <span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SolitaryWave</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">d_here</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcNorth</span> <span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">&lt;=</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">B_here</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
                        <span class="n">bcwave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoundSineWaves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nwaves</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">WaveData</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">d_here</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_g</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSL</span><span class="p">,</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bcwave</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">d_here</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nSL</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span>
                        <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="mf">10.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span>
                        <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.1415</span> <span class="o">/</span> <span class="mf">2.0</span>
                        <span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SolitaryWave</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">d_here</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">eta</span><span class="p">,</span><span class="n">hu</span><span class="p">,</span><span class="n">hv</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1">#Compute the coordinates of the neighbors</span>
                <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">upIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">downIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span> <span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">B_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span>
                <span class="n">B_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span>
                <span class="n">B_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">state_south</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span>
                <span class="n">state_north</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span>
                <span class="n">state_west</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">state_east</span> <span class="o">=</span> <span class="n">txState</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">eta_here</span> <span class="o">=</span>  <span class="n">BCState</span><span class="o">.</span><span class="n">x</span> <span class="c1">#</span>
                <span class="n">eta_west</span> <span class="o">=</span> <span class="n">state_west</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_east</span> <span class="o">=</span> <span class="n">state_east</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_south</span> <span class="o">=</span> <span class="n">state_south</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_north</span> <span class="o">=</span> <span class="n">state_north</span><span class="o">.</span><span class="n">x</span>

                <span class="n">h_here</span>  <span class="o">=</span> <span class="n">eta_here</span> <span class="o">-</span> <span class="n">B_here</span> <span class="c1"># CHANGE</span>
                <span class="n">h_south</span> <span class="o">=</span> <span class="n">eta_south</span> <span class="o">-</span> <span class="n">B_south</span>
                <span class="n">h_north</span> <span class="o">=</span> <span class="n">eta_north</span> <span class="o">-</span> <span class="n">B_north</span>
                <span class="n">h_west</span> <span class="o">=</span> <span class="n">eta_west</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">eta_east</span> <span class="o">-</span> <span class="n">B_east</span>

                <span class="n">h_cut</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">h_cut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span><span class="o">-</span><span class="n">B_north</span><span class="p">))</span>
                <span class="n">h_cut</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span><span class="o">-</span><span class="n">B_east</span><span class="p">))</span>
                <span class="n">h_cut</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span><span class="o">-</span><span class="n">B_south</span><span class="p">))</span>
                <span class="n">h_cut</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span><span class="o">-</span><span class="n">B_west</span><span class="p">))</span>

                <span class="n">dry_here</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dry_west</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dry_east</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dry_south</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dry_north</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">h_here</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                    <span class="n">dry_here</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">h_west</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="o">.</span><span class="n">w</span><span class="p">:</span>
                    <span class="n">dry_west</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">h_east</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
                    <span class="n">dry_east</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">h_south</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="o">.</span><span class="n">z</span><span class="p">:</span>
                    <span class="n">dry_south</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">h_north</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
                    <span class="n">dry_north</span><span class="o">=</span><span class="mi">0</span>

                <span class="n">sum_dry</span> <span class="o">=</span> <span class="n">dry_west</span> <span class="o">+</span> <span class="n">dry_east</span> <span class="o">+</span> <span class="n">dry_south</span> <span class="o">+</span> <span class="n">dry_north</span>

                <span class="n">h_min</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span><span class="n">h_north</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span><span class="n">h_east</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span><span class="n">h_south</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span><span class="n">h_west</span><span class="p">)</span>

                <span class="c1">#wetdry = ti.min(h_here, ti.min(h_south, ti.min(h_north, ti.min(h_west, h_east))))</span>
                <span class="c1">#nearshore = ti.min(B_here, ti.min(B_south, ti.min(B_north, ti.min(B_west, B_east))))</span>

                <span class="c1"># Remove islands</span>
                <span class="k">if</span> <span class="n">dry_here</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sum_dry</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">B_here</span><span class="o">&lt;=</span><span class="mf">0.0</span><span class="p">):</span>
                            <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">BCState</span><span class="o">.</span><span class="n">x</span> <span class="p">,</span> <span class="n">B_here</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                            <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">B_here</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                            <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">sum_dry</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">wet_eta</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dry_west</span><span class="p">)</span><span class="o">*</span><span class="n">eta_west</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">dry_east</span><span class="p">)</span><span class="o">*</span><span class="n">eta_east</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">dry_south</span><span class="p">)</span><span class="o">*</span><span class="n">eta_south</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">dry_north</span><span class="p">)</span><span class="o">*</span><span class="n">eta_north</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">sum_dry</span><span class="p">)</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">wet_eta</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c1"># Check for negative depths</span>
                <span class="n">h_here</span> <span class="o">=</span> <span class="n">BCState</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">B_here</span>  <span class="c1"># To change</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">h_here</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">B_here</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">):</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">BCState</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">B_here</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">BCState</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">B_here</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="n">BCState_Sed</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="n">txState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">BCState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NewState_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">BCState_Sed</span></div>



<div class="viewcode-block" id="Solver.copy_states">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.copy_states">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">src</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">(),</span> <span class="n">dst</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies state data from one Taichi field to another, ensuring shapes match.</span>

<span class="sd">        Args:</span>
<span class="sd">            src (ti.field): Source Taichi field.</span>
<span class="sd">            dst (ti.field): Destination Taichi field.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If shapes of src and dst do not match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ti</span><span class="o">.</span><span class="n">static_assert</span><span class="p">(</span><span class="n">dst</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;copy() needs src and dst fields to be same shape&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="n">ti</span><span class="o">.</span><span class="n">grouped</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">I</span><span class="p">]</span></div>



<div class="viewcode-block" id="Solver.tridiag_coeffs_X">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.tridiag_coeffs_X">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tridiag_coeffs_X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills tridiagonal coefficient arrays in x-direction (coefMatx) for the </span>
<span class="sd">        Boussinesq model. These coefficients are used later in the parallel cyclic </span>
<span class="sd">        reduction solver (PCR) to handle dispersion terms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Bottom</span><span class="p">,</span><span class="n">dx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">ti</span><span class="o">.</span><span class="n">loop_config</span><span class="p">(</span><span class="n">serialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">loop_config</span><span class="p">(</span><span class="n">serialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">):</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="n">neardry</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">i</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">neardry</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">depth_here</span> <span class="o">=</span> <span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">depth_plus</span> <span class="o">=</span> <span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">depth_minus</span> <span class="o">=</span> <span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="c1"># Calculate the first derivative</span>
                    <span class="n">d_dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_plus</span> <span class="o">-</span> <span class="n">depth_minus</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
                    <span class="c1"># Calculate coefficients</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">depth_here</span> <span class="o">*</span> <span class="n">d_dx</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth_here</span> <span class="o">*</span> <span class="n">depth_here</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth_here</span> <span class="o">*</span> <span class="n">depth_here</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">depth_here</span> <span class="o">*</span> <span class="n">d_dx</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth_here</span> <span class="o">*</span> <span class="n">depth_here</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span></div>



<div class="viewcode-block" id="Solver.tridiag_coeffs_Y">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.tridiag_coeffs_Y">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tridiag_coeffs_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills tridiagonal coefficient arrays in y-direction (coefMaty) for the </span>
<span class="sd">        Boussinesq model. These coefficients are used later in the parallel cyclic </span>
<span class="sd">        reduction solver (PCR) to handle dispersion terms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Bottom</span><span class="p">,</span><span class="n">dy</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">ti</span><span class="o">.</span><span class="n">loop_config</span><span class="p">(</span><span class="n">serialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">ti</span><span class="o">.</span><span class="n">loop_config</span><span class="p">(</span><span class="n">serialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">):</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="n">neardry</span> <span class="o">=</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">j</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">-</span><span class="mi">3</span> <span class="ow">or</span> <span class="n">neardry</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">depth_here</span> <span class="o">=</span> <span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">depth_plus</span> <span class="o">=</span> <span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">depth_minus</span> <span class="o">=</span> <span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Calculate the first derivative</span>
                    <span class="n">d_dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_plus</span> <span class="o">-</span> <span class="n">depth_minus</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
                    <span class="c1"># Calculate coefficients</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">depth_here</span> <span class="o">*</span> <span class="n">d_dy</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth_here</span> <span class="o">*</span> <span class="n">depth_here</span> <span class="o">/</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth_here</span> <span class="o">*</span> <span class="n">depth_here</span> <span class="o">/</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">depth_here</span> <span class="o">*</span> <span class="n">d_dy</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth_here</span> <span class="o">*</span> <span class="n">depth_here</span> <span class="o">/</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
                <span class="c1"># Store the coefficients in the texture field</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span></div>




<div class="viewcode-block" id="Solver.Pass1">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Pass1">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pass1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="p">:</span><span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstruction step (Pass1):</span>
<span class="sd">          - Builds left/right (or N/E/S/W) interface values of eta, momentum, and </span>
<span class="sd">            scalar concentration using a generalized minmod limiter.</span>
<span class="sd">          - Applies near-dry checks to skip processing cells that are effectively dry.</span>
<span class="sd">          - Computes velocity components and partial Froude-limiter logic.</span>

<span class="sd">        For 1D (ny=1), a simpler logic is used. For 2D, reconstruction is in both </span>
<span class="sd">        x- and y-directions.</span>

<span class="sd">        Args:</span>
<span class="sd">            step (int): Counter to compute statistics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zro</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># RUN 1D</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
                <span class="c1"># Compute the coordinates of the neighbors</span>
                <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="c1">#Read in the state of the water at this pixel and its neighbors [eta,hu,hv,c]</span>
                <span class="n">in_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">in_W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">in_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">leftIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">rightIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="c1"># h = eta - B</span>
                <span class="n">h_here</span>  <span class="o">=</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span>
                <span class="n">h_west</span> <span class="o">=</span> <span class="n">in_W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_east</span>

                <span class="c1"># Define h_near = eta_near - B_near</span>
                <span class="c1"># HNear_vec neighbours [hN,hE,hS,hW]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hnear</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">h_east</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="n">h_west</span><span class="p">]</span>

                <span class="c1"># To avoid unnecesary computations</span>
                <span class="n">h_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
                <span class="k">if</span> <span class="n">h_here</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">h_east</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_west</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="k">continue</span>
                <span class="c1">########################################################</span>
                <span class="c1"># Pass 1</span>
                <span class="c1"># Load bed elevation data for this cell&#39;s edges.</span>
                <span class="c1"># B neighbours [BN,BE,BS,BW]</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">leftIdx</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">dB_max</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">dB_west</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_west</span><span class="p">)</span>
                <span class="n">dB_east</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_east</span><span class="p">)</span>
               
                <span class="c1"># Initialize variables for water height, momentum components, and standard deviation</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">hu</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">hc</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="c1"># modify limiters based on whether near the inundation limit</span>
                <span class="n">wetdry</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_west</span><span class="p">,</span> <span class="n">h_east</span><span class="p">))</span>
                <span class="n">rampcoef</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wetdry</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.02</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="c1">#transition to full upwinding near the shoreline / inundation limit, start transition with a total water depth of base_depth/50</span>
                <span class="n">TWO_THETAc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_theta</span> <span class="o">*</span> <span class="n">rampcoef</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rampcoef</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">wetdry</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="p">:</span>
                    <span class="n">dB_max</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dB_east</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dB_west</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="c1"># Reconstruction eta</span>
                <span class="n">wwy</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wwy</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

                <span class="c1"># Reconstruct h from (corrected) w</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">B</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">))</span>

                <span class="c1"># Reconstruction hu ~P</span>
                <span class="n">huwy</span>  <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">hu</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">huwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">huwy</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

                <span class="c1"># Reconstruction hv - Q</span>
                <span class="c1">#hvwy = Reconstruct(in_W[2], in_here[2], in_E[2],TWO_THETAc)</span>
                <span class="n">hv</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

                <span class="c1"># Reconstruction hc - scalar - sediment concentration or contaminent</span>
                <span class="n">hcwy</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">hc</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hcwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">hcwy</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

                <span class="n">output_u</span><span class="p">,</span> <span class="n">output_v</span><span class="p">,</span> <span class="n">output_c</span> <span class="o">=</span> <span class="n">CalcUV</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hu</span><span class="p">,</span> <span class="n">hv</span><span class="p">,</span> <span class="n">hc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">dB_max</span><span class="p">)</span>

                <span class="c1">#Froude number limiter</span>
                <span class="n">epsilon_c</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">dB_max</span><span class="p">)</span>
                <span class="n">divide_by_h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">epsilon_c</span><span class="p">))</span>

                <span class="n">Fr</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">output_u</span><span class="o">*</span><span class="n">output_u</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">9.81</span> <span class="o">/</span> <span class="n">divide_by_h</span><span class="p">))</span>
                <span class="n">Frumax</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
                <span class="n">dBdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_east</span> <span class="o">-</span> <span class="n">B_west</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_dx</span>
                <span class="c1">#max Fr allowed on slopes less than 45 degrees is 3;</span>
                <span class="c1">#for very steep slopes, artificially slow velocity - physics are just completely wrong here anyhow</span>
                <span class="n">Fr_maxallowed</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dBdx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Frumax</span> <span class="o">&gt;</span> <span class="n">Fr_maxallowed</span> <span class="p">:</span>
                    <span class="n">Fr_red</span> <span class="o">=</span> <span class="n">Fr_maxallowed</span> <span class="o">/</span> <span class="n">Frumax</span>
                    <span class="n">output_u</span> <span class="o">=</span> <span class="n">output_u</span> <span class="o">*</span> <span class="n">Fr_red</span>
                
                <span class="c1"># compute statistics of flow depth</span>
                <span class="n">flow_depth</span> <span class="o">=</span> <span class="p">(</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">maxInundatedDepth</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flow_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">minFlow_depth</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flow_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">meanFlow_depth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">step</span> <span class="o">+</span> <span class="n">flow_depth</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


                <span class="c1"># Write H, U, V, C vector fields</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_u</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_c</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">maxInundatedDepth</span><span class="p">,</span> <span class="n">minFlow_depth</span><span class="p">,</span> <span class="n">meanFlow_depth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
                <span class="c1"># Compute the coordinates of the neighbors</span>
                <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">upIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">downIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="c1">#Read in the state of the water at this pixel and its neighbors [eta,hu,hv,c]</span>
                <span class="n">in_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">in_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">downIdx</span><span class="p">]</span>
                <span class="n">in_N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">upIdx</span><span class="p">]</span>
                <span class="n">in_W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">in_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">downIdx</span><span class="p">]</span>
                <span class="n">B_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">upIdx</span><span class="p">]</span>
                <span class="n">B_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">leftIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">rightIdx</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="c1"># h = eta - B</span>
                <span class="n">h_here</span>  <span class="o">=</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span>
                <span class="n">h_south</span> <span class="o">=</span> <span class="n">in_S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_south</span>
                <span class="n">h_north</span> <span class="o">=</span> <span class="n">in_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_north</span>
                <span class="n">h_west</span> <span class="o">=</span> <span class="n">in_W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_east</span>

                <span class="c1"># Define h_near = eta_near - B_near</span>
                <span class="c1"># HNear_vec neighbours [hN,hE,hS,hW]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hnear</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_north</span><span class="p">,</span>  <span class="n">h_east</span><span class="p">,</span> <span class="n">h_south</span> <span class="p">,</span> <span class="n">h_west</span><span class="p">]</span>

                <span class="c1"># To avoid unnecesary computations</span>
                <span class="n">h_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
                <span class="k">if</span> <span class="n">h_here</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">h_north</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_east</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_south</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_west</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="k">continue</span>

                <span class="c1">########################################################</span>
                <span class="c1"># Pass 1</span>
                <span class="c1"># Load bed elevation data for this cell&#39;s edges.</span>
                <span class="c1"># B neighbours [BN,BE,BS,BW]</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="p">,</span> <span class="n">downIdx</span><span class="p">]</span>
                <span class="n">B</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">leftIdx</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">dB_max</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="n">dB_west</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_west</span><span class="p">)</span>
                <span class="n">dB_east</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_east</span><span class="p">)</span>
                <span class="n">dB_south</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_south</span><span class="p">)</span>
                <span class="n">dB_north</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_north</span><span class="p">)</span>

                <span class="c1"># Initialize variables for water height, momentum components, and standard deviation</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">hu</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">hv</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">hc</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="c1"># modify limiters based on whether near the inundation limit</span>
                <span class="n">wetdry</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_south</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_north</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_west</span><span class="p">,</span> <span class="n">h_east</span><span class="p">))))</span>
                <span class="n">rampcoef</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wetdry</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.02</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="c1">#transition to full upwinding near the shoreline / inundation limit, start transition with a total water depth of base_depth/50</span>
                <span class="n">TWO_THETAc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_theta</span> <span class="o">*</span> <span class="n">rampcoef</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rampcoef</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">wetdry</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="p">:</span>
                    <span class="n">dB_max</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">dB_north</span><span class="p">,</span> <span class="n">dB_east</span><span class="p">,</span> <span class="n">dB_south</span><span class="p">,</span> <span class="n">dB_west</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="c1"># Reconstruction eta</span>
                <span class="n">wwy</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">wzx</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_S</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in_N</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">wzx</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">wwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">wzx</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">wwy</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

                <span class="c1"># Reconstruct h from (corrected) w</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">B</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">))</span>

                <span class="c1"># Reconstruction hu ~P</span>
                <span class="n">huwy</span>  <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">huzx</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_S</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_N</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">hu</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">huzx</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">huwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">huzx</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">huwy</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

                <span class="c1"># Reconstruction hv - Q</span>
                <span class="n">hvwy</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">hvzx</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_S</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">in_N</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">hv</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">hvzx</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">hvwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">hvzx</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">hvwy</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

                <span class="c1"># Reconstruction hc - scalar - sediment concentration or contaminent</span>
                <span class="n">hcwy</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">in_E</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">hczx</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_S</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">in_here</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">in_N</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">TWO_THETAc</span><span class="p">)</span>
                <span class="n">hc</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">hczx</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">hcwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">hczx</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">hcwy</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

                <span class="n">output_u</span><span class="p">,</span> <span class="n">output_v</span><span class="p">,</span> <span class="n">output_c</span> <span class="o">=</span> <span class="n">CalcUV</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hu</span><span class="p">,</span> <span class="n">hv</span><span class="p">,</span> <span class="n">hc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">dB_max</span><span class="p">)</span>

                <span class="c1">#Froude number limiter</span>
                <span class="n">epsilon_c</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">dB_max</span><span class="p">)</span>
                <span class="n">divide_by_h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">epsilon_c</span><span class="p">))</span>

                <span class="n">Fr</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">output_u</span><span class="o">*</span><span class="n">output_u</span> <span class="o">+</span> <span class="n">output_v</span><span class="o">*</span><span class="n">output_v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">9.81</span> <span class="o">/</span> <span class="n">divide_by_h</span><span class="p">))</span>
                <span class="n">Frumax</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">)))</span>
                <span class="n">dBdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_east</span> <span class="o">-</span> <span class="n">B_west</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_dx</span>
                <span class="n">dBdy</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_north</span> <span class="o">-</span> <span class="n">B_south</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_dy</span>
                <span class="n">dBds_max</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dBdx</span><span class="p">,</span> <span class="n">dBdy</span><span class="p">)</span>
                <span class="c1">#max Fr allowed on slopes less than 45 degrees is 3;</span>
                <span class="c1">#for very steep slopes, artificially slow velocity - physics are just completely wrong here anyhow</span>
                <span class="n">Fr_maxallowed</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dBds_max</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Frumax</span> <span class="o">&gt;</span> <span class="n">Fr_maxallowed</span> <span class="p">:</span>
                    <span class="n">Fr_red</span> <span class="o">=</span> <span class="n">Fr_maxallowed</span> <span class="o">/</span> <span class="n">Frumax</span>
                    <span class="n">output_u</span> <span class="o">=</span> <span class="n">output_u</span> <span class="o">*</span> <span class="n">Fr_red</span>
                    <span class="n">output_v</span> <span class="o">=</span> <span class="n">output_v</span> <span class="o">*</span> <span class="n">Fr_red</span>

                <span class="c1"># compute statistics of flow depth</span>
                <span class="n">flow_depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>
                <span class="n">maxInundatedDepth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">flow_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">minInundatedDepth</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">flow_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">meanFlow_depth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">step</span> <span class="o">+</span> <span class="n">flow_depth</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Write H, U, V, C vector fields</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_u</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_v</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_c</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Auxiliary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">maxInundatedDepth</span><span class="p">,</span> <span class="n">minInundatedDepth</span><span class="p">,</span><span class="n">meanFlow_depth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span></div>



<div class="viewcode-block" id="Solver.Pass1_SedTrans">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Pass1_SedTrans">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pass1_SedTrans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstruction step (Pass1) for sediment transport scalar. Uses the same </span>
<span class="sd">        generalized minmod approach to reconstruct sediment concentration at edges.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">:</span>
            <span class="c1"># Compute the coordinates of the neighbors</span>
            <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">upIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">downIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">in_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">in_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">in_N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">upIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">in_W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">leftIdx</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">in_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">rightIdx</span> <span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

            <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">B_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span>
            <span class="n">B_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">upIdx</span><span class="p">]</span>
            <span class="n">B_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">B_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="n">dB_west</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_west</span><span class="p">)</span>
            <span class="n">dB_east</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_east</span><span class="p">)</span>
            <span class="n">dB_south</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_south</span><span class="p">)</span>
            <span class="n">dB_north</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_here</span> <span class="o">-</span> <span class="n">B_north</span><span class="p">)</span>

            <span class="n">dB_max</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">dB_north</span><span class="p">,</span> <span class="n">dB_east</span><span class="p">,</span> <span class="n">dB_south</span><span class="p">,</span> <span class="n">dB_west</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

            <span class="n">h_here</span>  <span class="o">=</span> <span class="n">in_here</span> <span class="o">-</span> <span class="n">B_here</span>
            <span class="n">h_south</span> <span class="o">=</span> <span class="n">in_S</span> <span class="o">-</span> <span class="n">B_south</span>
            <span class="n">h_north</span> <span class="o">=</span> <span class="n">in_N</span> <span class="o">-</span> <span class="n">B_north</span>
            <span class="n">h_west</span> <span class="o">=</span> <span class="n">in_W</span> <span class="o">-</span> <span class="n">B_west</span>
            <span class="n">h_east</span> <span class="o">=</span> <span class="n">in_E</span> <span class="o">-</span> <span class="n">B_east</span>

            <span class="c1"># Pass 1</span>
            <span class="c1">#  Initialize local variables (thread)</span>
            <span class="n">hc</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

            <span class="c1"># modify limiters based on whether near the inundation limit</span>
            <span class="n">wetdry</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_south</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_north</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_west</span><span class="p">,</span> <span class="n">h_east</span><span class="p">))))</span>
            <span class="n">rampcoef</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">wetdry</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.02</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">)</span>

            <span class="c1">#transition to full upwinding near the shoreline / inundation limit, start transition with a total water depth of base_depth/50</span>
            <span class="n">TWO_THETAc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_theta</span> <span class="o">*</span> <span class="n">rampcoef</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rampcoef</span><span class="p">)</span>


            <span class="c1"># Reconstruction class1</span>
            <span class="n">hcwy</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_W</span><span class="p">,</span> <span class="n">in_here</span><span class="p">,</span> <span class="n">in_E</span><span class="p">,</span><span class="n">TWO_THETAc</span><span class="p">)</span>
            <span class="n">hczx</span> <span class="o">=</span> <span class="n">Reconstruct</span><span class="p">(</span><span class="n">in_S</span><span class="p">,</span> <span class="n">in_here</span><span class="p">,</span> <span class="n">in_N</span><span class="p">,</span><span class="n">TWO_THETAc</span><span class="p">)</span>

            <span class="n">hc</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">hczx</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">hcwy</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">hczx</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">hcwy</span><span class="o">.</span><span class="n">x</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="n">epsilon_c</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">dB_max</span><span class="p">)</span>
            <span class="n">divide_by_h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">epsilon_c</span><span class="p">))</span>

            <span class="n">c_sed</span> <span class="o">=</span> <span class="n">divide_by_h</span> <span class="o">*</span> <span class="n">hc</span>

            <span class="c1"># Write Sediment concentration by edge</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_sed</span></div>



<div class="viewcode-block" id="Solver.Pass2">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Pass2">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pass2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flux computation step (Pass2):</span>
<span class="sd">          - Computes fluxes at each cell edge in x and y directions using the function </span>
<span class="sd">            numerical flux.</span>
<span class="sd">          - If sediment transport is enabled, calculates sediment fluxes similarly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># RUN 1D</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hnear</span><span class="p">:</span>
                    <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">h_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hnear</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                    <span class="n">h_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                    <span class="n">h_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">hW_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                    
                    <span class="n">u_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                    <span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">uW_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

                    <span class="c1"># Compute wave speeds</span>
                    <span class="n">cNE</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span><span class="p">)</span>
                    <span class="n">cW</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">hW_east</span><span class="p">)</span>     <span class="c1"># cW evaluated at (j+1, k)</span>
                    
                    <span class="c1"># Compute propagation speeds</span>
                    <span class="n">aplus</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cNE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uW_east</span> <span class="o">+</span> <span class="n">cW</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">aminus</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cNE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uW_east</span> <span class="o">-</span> <span class="n">cW</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

                    <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="c1">#dB = ti.max(self.Bottom[2,i, downIdx] - B_here, ti.max(self.Bottom[2,i,upIdx] - B_here, ti.max(self.Bottom[2,leftIdx,j] - B_here, self.Bottom[2,rightIdx,j] - B_here)))</span>

                    <span class="n">c_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                    <span class="n">c_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">cW_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                  
                    <span class="n">phix</span> <span class="o">=</span> <span class="mf">0.5</span>
                    <span class="n">minH</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_vec</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">h_vec</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">mass_diff_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">hW_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

                    <span class="n">P_diff_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">minH</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">:</span>
                        <span class="n">mass_diff_x</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">phix</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="n">xflux</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                    <span class="n">xflux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">mass_diff_x</span><span class="p">)</span>
                    <span class="n">xflux</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">*</span> <span class="n">uW_east</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P_diff_x</span><span class="p">)</span>
                    <span class="n">xflux</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">*</span> <span class="n">cW_east</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">c_here</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">phix</span><span class="o">*</span><span class="p">(</span><span class="n">hW_east</span> <span class="o">*</span> <span class="n">cW_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">c_here</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

                    <span class="c1"># Write Fluxes fluid</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">xflux</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useSedTransModel</span><span class="o">==</span><span class="kc">True</span> <span class="p">:</span>
                        <span class="n">c1_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                        <span class="n">c1_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">c1_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">c1W_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

                        <span class="n">xflux_Sed</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">*</span><span class="n">c1W_east</span><span class="p">,</span> <span class="n">h_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c1_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phix</span><span class="o">*</span><span class="p">(</span><span class="n">hW_east</span><span class="o">*</span><span class="n">c1W_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">c1_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="c1"># Write Fluxes sediment by classes</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">XFlux_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xflux_Sed</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hnear</span><span class="p">:</span>
                <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">upIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">downIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">h_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hnear</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">h_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">h_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">h_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">hW_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">hS_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">upIdx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">u_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">u_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">uW_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">uS_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">upIdx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">v_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">v_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">vW_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">rightIdx</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">vS_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">upIdx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="c1"># Compute wave speeds</span>
                <span class="n">cNE</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span><span class="p">)</span>
                <span class="n">cW</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">hW_east</span><span class="p">)</span>     <span class="c1"># cW evaluated at (j+1, k)</span>
                <span class="n">cS</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">hS_north</span><span class="p">)</span>    <span class="c1"># cS evaluated at (j, k+1)</span>

                <span class="c1"># Compute propagation speeds</span>
                <span class="n">aplus</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cNE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uW_east</span> <span class="o">+</span> <span class="n">cW</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">aminus</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cNE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uW_east</span> <span class="o">-</span> <span class="n">cW</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">bplus</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cNE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vS_north</span> <span class="o">+</span> <span class="n">cS</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">bminus</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cNE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vS_north</span> <span class="o">-</span> <span class="n">cS</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">dB</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">downIdx</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span><span class="p">)))</span>

                <span class="c1">#near_dry = self.Bottom[3,pi, pj] # Check the value of this field not used in here</span>

                <span class="n">c_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">c_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">c_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">cW_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">cS_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">upIdx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">phix</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">phiy</span> <span class="o">=</span> <span class="mf">0.5</span>

                <span class="n">minH</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_vec</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_vec</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_vec</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">h_vec</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">mass_diff_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">hW_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">mass_diff_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">hS_north</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

                <span class="n">P_diff_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">P_diff_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">hS_north</span> <span class="o">*</span> <span class="n">uS_north</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

                <span class="n">Q_diff_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">hW_east</span> <span class="o">*</span> <span class="n">vW_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">Q_diff_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">hS_north</span> <span class="o">*</span> <span class="n">vS_north</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">minH</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="p">:</span>
                    <span class="n">mass_diff_x</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">mass_diff_y</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">phix</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">phiy</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="n">xflux</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">yflux</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="n">xflux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">mass_diff_x</span><span class="p">)</span>
                <span class="n">xflux</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">*</span> <span class="n">uW_east</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P_diff_x</span><span class="p">)</span>
                <span class="n">xflux</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">*</span> <span class="n">vW_east</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Q_diff_x</span> <span class="p">)</span>
                <span class="n">xflux</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">*</span> <span class="n">cW_east</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">c_here</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">phix</span><span class="o">*</span><span class="p">(</span><span class="n">hW_east</span> <span class="o">*</span> <span class="n">cW_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">c_here</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

                <span class="n">yflux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">bplus</span><span class="p">,</span> <span class="n">bminus</span><span class="p">,</span> <span class="n">hS_north</span> <span class="o">*</span> <span class="n">vS_north</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">mass_diff_y</span><span class="p">)</span>
                <span class="n">yflux</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">bplus</span><span class="p">,</span> <span class="n">bminus</span><span class="p">,</span> <span class="n">hS_north</span> <span class="o">*</span> <span class="n">uS_north</span> <span class="o">*</span> <span class="n">vS_north</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">u_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P_diff_y</span><span class="p">)</span>
                <span class="n">yflux</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">bplus</span><span class="p">,</span> <span class="n">bminus</span><span class="p">,</span> <span class="n">hS_north</span> <span class="o">*</span> <span class="n">vS_north</span> <span class="o">*</span> <span class="n">vS_north</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">Q_diff_y</span><span class="p">)</span>
                <span class="n">yflux</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">bplus</span><span class="p">,</span> <span class="n">bminus</span><span class="p">,</span> <span class="n">hS_north</span> <span class="o">*</span> <span class="n">cS_north</span> <span class="o">*</span> <span class="n">vS_north</span><span class="p">,</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">c_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">v_here</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">phiy</span><span class="o">*</span><span class="p">(</span><span class="n">hS_north</span> <span class="o">*</span> <span class="n">cS_north</span> <span class="o">-</span> <span class="n">h_here</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">c_here</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>

                <span class="c1"># Write Fluxes fluid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">xflux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">yflux</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useSedTransModel</span><span class="o">==</span><span class="kc">True</span> <span class="p">:</span>
                    <span class="n">c1_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                    <span class="n">c1_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">c1_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">c1W_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">c1S_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Sed_C</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">upIdx</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">xflux_Sed</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">aplus</span><span class="p">,</span> <span class="n">aminus</span><span class="p">,</span> <span class="n">hW_east</span> <span class="o">*</span> <span class="n">uW_east</span> <span class="o">*</span><span class="n">c1W_east</span><span class="p">,</span> <span class="n">h_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">c1_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phix</span><span class="o">*</span><span class="p">(</span><span class="n">hW_east</span><span class="o">*</span><span class="n">c1W_east</span> <span class="o">-</span> <span class="n">h_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">c1_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">yflux_Sed</span> <span class="o">=</span> <span class="n">NumericalFlux</span><span class="p">(</span><span class="n">bplus</span><span class="p">,</span> <span class="n">bminus</span><span class="p">,</span> <span class="n">hS_north</span> <span class="o">*</span><span class="n">c1S_north</span> <span class="o">*</span> <span class="n">vS_north</span><span class="p">,</span> <span class="n">h_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span><span class="n">c1_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_here</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phiy</span> <span class="o">*</span><span class="p">(</span><span class="n">hS_north</span><span class="o">*</span><span class="n">c1S_north</span> <span class="o">-</span> <span class="n">h_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">c1_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                    <span class="c1"># Write Fluxes sediment by classes</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">XFlux_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xflux_Sed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">YFlux_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">yflux_Sed</span></div>



<div class="viewcode-block" id="Solver.Pass3">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Pass3">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pass3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pred_or_corrector</span><span class="p">:</span><span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main time-update step (Pass3) for the SWE model:</span>
<span class="sd">          - Updates eta, hu, hv, c for each cell based on fluxes and source terms </span>
<span class="sd">            (bed slope, friction, infiltration, etc.).</span>
<span class="sd">          - Uses an explicit time scheme (Euler,  predictor,  predictor/corrector).</span>
<span class="sd">          - Optionally includes a foam/breaking parameter if showBreaking&gt;0.</span>

<span class="sd">        Args:</span>
<span class="sd">            pred_or_corrector (int): Stage in predictor-corrector scheme (1 =&gt; predictor, 2 =&gt; corrector).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zro</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="k">continue</span>
                <span class="c1"># Load values from txBottom using index</span>
                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="c1">#</span>

                <span class="n">in_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="c1"># w, hu and hv, c (cell avgs, evaluated here)</span>
                <span class="n">in_state_here_UV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">B_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">eta_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">eta_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">eta_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">h_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span>
                <span class="n">h_west</span> <span class="o">=</span> <span class="n">eta_west</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">eta_east</span> <span class="o">-</span> <span class="n">B_east</span>

                <span class="n">h_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
                <span class="k">if</span> <span class="n">h_here</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">h_east</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_west</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="k">continue</span>

                <span class="n">h_min</span> <span class="o">=</span> <span class="n">zro</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_east</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_west</span><span class="p">)</span>

                <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>

                <span class="c1"># Load values from txXFlux and txYFlux using idx</span>
                <span class="n">xflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># at i+1/2</span>
                <span class="n">xflux_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># at i-1/2</span>

                <span class="n">friction_here</span> <span class="o">=</span>  <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">friction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BottomFriction</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">friction_</span> <span class="o">=</span> <span class="n">FrictionCalc</span><span class="p">(</span><span class="n">in_state_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">h_here</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">friction_here</span><span class="p">)</span>

                <span class="c1"># Pressure stencil calculations</span>
                <span class="n">P_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">press_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_right</span> <span class="o">-</span> <span class="n">P_left</span><span class="p">)</span>

                <span class="c1"># Calculate scalar transport additions</span>
                <span class="n">C_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

                <span class="n">Dxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>               

                <span class="n">hc_by_dx_dx</span> <span class="o">=</span> <span class="n">Dxx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">C_state_left</span><span class="p">)</span>

                <span class="n">c_dissipation</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDecayRate</span> <span class="o">*</span> <span class="n">C_state_here</span>

                <span class="n">breaking_B</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">useBreakingModel</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">breaking_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">z</span>  <span class="c1"># breaking front parameter, non-breaking [0 - 1] breaking</span>

                <span class="k">if</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_here</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>

                <span class="n">overflow_dry</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">B_here</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="p">:</span>
                    <span class="n">overflow_dry</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">infiltrationRate</span> <span class="c1">#hydraulic conductivity of coarse, unsaturated sand</span>

                <span class="n">source_term</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">overflow_dry</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detadx</span> <span class="o">-</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">friction_</span><span class="o">+</span><span class="n">press_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">hc_by_dx_dx</span> <span class="o">+</span> <span class="n">c_dissipation</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="n">d_by_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">xflux_west</span> <span class="o">-</span> <span class="n">xflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">+</span> <span class="n">source_term</span>

                <span class="c1"># previous derivatives</span>
                <span class="n">oldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldGradients</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">oldOldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldOldGradients</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">newState</span> <span class="o">=</span> <span class="n">zro</span>   <span class="c1"># w , hu, hv ,hc</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># if timeScheme is Euler do:</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">d_by_dt</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># if time scheme is predictor</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">12.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">23.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">-</span> <span class="mf">16.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># if time scheme is corrector</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictedGradients</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">24.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">9.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">+</span> <span class="mf">19.0</span><span class="o">*</span><span class="n">predicted</span> <span class="o">-</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span><span class="kc">True</span> <span class="p">:</span>
                    <span class="c1"># add breaking source</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">newState</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">breaking_B</span><span class="p">)</span> <span class="c1"># use the B value from Kennedy et al as a foam intensity</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                    <span class="n">contaminent_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ContSource</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newState</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">contaminent_source</span><span class="p">)</span>

                <span class="n">F_G_vec</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_by_dt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_G_vec</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="k">continue</span>

                <span class="c1"># Load values from txBottom using index</span>
                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="c1">#</span>

                <span class="n">in_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="c1"># w, hu and hv, c (cell avgs, evaluated here)</span>
                <span class="n">in_state_here_UV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">B_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">B_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">B_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">eta_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">eta_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">eta_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">eta_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">eta_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">h_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">B_here</span>
                <span class="n">h_west</span> <span class="o">=</span> <span class="n">eta_west</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">eta_east</span> <span class="o">-</span> <span class="n">B_east</span>
                <span class="n">h_north</span> <span class="o">=</span> <span class="n">eta_north</span> <span class="o">-</span> <span class="n">B_north</span>
                <span class="n">h_south</span> <span class="o">=</span> <span class="n">eta_south</span> <span class="o">-</span> <span class="n">B_south</span>

                <span class="n">h_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
                <span class="k">if</span> <span class="n">h_here</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">h_north</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_east</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_south</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_west</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="k">continue</span>

                <span class="n">h_min</span> <span class="o">=</span> <span class="n">zro</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_north</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_east</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_south</span><span class="p">)</span>
                <span class="n">h_min</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_west</span><span class="p">)</span>

                <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="n">detady</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">eta_north</span> <span class="o">-</span> <span class="n">eta_south</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                <span class="c1"># Load values from txXFlux and txYFlux using idx</span>
                <span class="n">xflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># at i+1/2</span>
                <span class="n">xflux_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># at i-1/2</span>
                <span class="n">yflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># at j+1/2</span>
                <span class="n">yflux_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># at j-1/2</span>

                <span class="n">friction_here</span> <span class="o">=</span>  <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">friction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BottomFriction</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">friction_</span> <span class="o">=</span> <span class="n">FrictionCalc</span><span class="p">(</span><span class="n">in_state_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">h_here</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">friction_here</span><span class="p">)</span>

                <span class="c1"># Pressure stencil calculations</span>
                <span class="n">P_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">press_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_right</span> <span class="o">-</span> <span class="n">P_left</span><span class="p">)</span>
                <span class="n">press_y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dy</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_up</span> <span class="o">-</span> <span class="n">P_down</span><span class="p">)</span>

                <span class="c1"># Calculate scalar transport additions</span>
                <span class="n">C_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

                <span class="n">C_state_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_up_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_up_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_down_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">C_state_down_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

                <span class="n">Dxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>
                <span class="n">Dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>
                <span class="n">Dyy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>

                <span class="n">hc_by_dx_dx</span> <span class="o">=</span> <span class="n">Dxx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">C_state_left</span><span class="p">)</span>
                <span class="n">hc_by_dy_dy</span> <span class="o">=</span> <span class="n">Dyy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2y</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_up</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">C_state_down</span><span class="p">)</span>
                <span class="n">hc_by_dx_dy</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">Dxy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dxdy</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_up_right</span> <span class="o">-</span> <span class="n">C_state_up_left</span> <span class="o">-</span> <span class="n">C_state_down_right</span> <span class="o">+</span> <span class="n">C_state_down_left</span><span class="p">)</span>

                <span class="n">c_dissipation</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDecayRate</span> <span class="o">*</span> <span class="n">C_state_here</span>

                <span class="n">breaking_B</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">useBreakingModel</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">breaking_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">z</span>  <span class="c1"># breaking front parameter, non-breaking [0 - 1] breaking</span>

                <span class="c1"># fix slope near shoreline</span>
                <span class="k">if</span> <span class="n">h_min</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_min</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="p">:</span>
                    <span class="n">detady</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="p">:</span>
                    <span class="n">detady</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_here</span> <span class="o">-</span> <span class="n">eta_south</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="p">:</span>
                    <span class="n">detady</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_north</span> <span class="o">-</span> <span class="n">eta_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                <span class="k">if</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_here</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>

                <span class="n">overflow_dry</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">B_here</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="p">:</span>
                    <span class="n">overflow_dry</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">infiltrationRate</span> <span class="c1">#hydraulic conductivity of coarse, unsaturated sand</span>

                <span class="n">source_term</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">overflow_dry</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detadx</span> <span class="o">-</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">friction_</span><span class="o">+</span><span class="n">press_x</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detady</span> <span class="o">-</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">friction_</span><span class="o">+</span><span class="n">press_y</span><span class="p">,</span> <span class="n">hc_by_dx_dx</span> <span class="o">+</span> <span class="n">hc_by_dy_dy</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">hc_by_dx_dy</span> <span class="o">+</span> <span class="n">c_dissipation</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="n">d_by_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">xflux_west</span> <span class="o">-</span> <span class="n">xflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">+</span> <span class="p">(</span><span class="n">yflux_south</span> <span class="o">-</span> <span class="n">yflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">+</span> <span class="n">source_term</span>

                <span class="c1"># previous derivatives</span>
                <span class="n">oldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldGradients</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">oldOldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldOldGradients</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>

                <span class="n">newState</span> <span class="o">=</span> <span class="n">zro</span>   <span class="c1"># w , hu, hv ,hc</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># if timeScheme is Euler do:</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">d_by_dt</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># if time scheme is predictor</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">12.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">23.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">-</span> <span class="mf">16.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># if time scheme is corrector</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictedGradients</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">24.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">9.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">+</span> <span class="mf">19.0</span><span class="o">*</span><span class="n">predicted</span> <span class="o">-</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span><span class="kc">True</span> <span class="p">:</span>
                    <span class="c1"># add breaking source</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">newState</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">breaking_B</span><span class="p">)</span> <span class="c1"># use the B value from Kennedy et al as a foam intensity</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                    <span class="n">contaminent_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ContSource</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newState</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">contaminent_source</span><span class="p">)</span>

                <span class="n">F_G_vec</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_by_dt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_G_vec</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span></div>



<div class="viewcode-block" id="Solver.Pass3_SedTrans">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Pass3_SedTrans">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pass3_SedTrans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pred_or_corrector</span><span class="p">:</span><span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Time-update step (Pass3) for sediment transport scalar:</span>
<span class="sd">          - Uses fluxes (XFlux_Sed, YFlux_Sed) plus simple diffusion. </span>
<span class="sd">          - Adds erosion/deposition terms based on local shear velocity or critical Shields.</span>

<span class="sd">        Args:</span>
<span class="sd">            pred_or_corrector (int): Stage in predictor-corrector scheme (1 =&gt; predictor, 2 =&gt; corrector).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NewState_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">continue</span>
            <span class="c1"># Load values from txXFlux and txYFlux using idx</span>
            <span class="n">xflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>  <span class="c1"># at i+1/2</span>
            <span class="n">xflux_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux_Sed</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>  <span class="c1"># at i-1/2</span>
            <span class="n">yflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>  <span class="c1"># at j+1/2</span>
            <span class="n">yflux_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>  <span class="c1"># at j-1/2</span>

            <span class="c1"># Calculate scalar transport additions</span>
            <span class="n">C_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_up_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_up_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_down_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">C_state_down_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State_Sed</span><span class="p">[</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

            <span class="n">Dxx</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Dxy</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Dyy</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">hc_by_dx_dx</span> <span class="o">=</span> <span class="n">Dxx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">C_state_here</span> <span class="o">+</span> <span class="n">C_state_left</span><span class="p">)</span>
            <span class="n">hc_by_dy_dy</span> <span class="o">=</span> <span class="n">Dyy</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2y</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_up</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">C_state_here</span> <span class="o">+</span> <span class="n">C_state_down</span><span class="p">)</span>
            <span class="n">hc_by_dx_dy</span> <span class="o">=</span> <span class="n">Dxy</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">one_over_dxdy</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_up_right</span> <span class="o">-</span> <span class="n">C_state_up_left</span> <span class="o">-</span> <span class="n">C_state_down_right</span> <span class="o">+</span> <span class="n">C_state_down_left</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span>

            <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="c1">#</span>
            <span class="n">in_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hu</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hv</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">-</span> <span class="n">B</span>

            <span class="n">divide_by_h</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>

            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="mf">9.81</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">friction</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">divide_by_h</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">hu</span> <span class="o">*</span> <span class="n">divide_by_h</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">hv</span> <span class="o">*</span> <span class="n">divide_by_h</span>

            <span class="n">local_speed</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">shear_velocity</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_speed</span>

            <span class="n">shields</span> <span class="o">=</span> <span class="n">shear_velocity</span> <span class="o">*</span> <span class="n">shear_velocity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">Shields</span>
            <span class="n">erosion</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">shields</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">CriticalShields</span><span class="p">:</span>
                <span class="n">erosion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">C_erosion</span> <span class="o">*</span> <span class="p">(</span><span class="n">shields</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">CriticalShields</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_speed</span> <span class="o">*</span> <span class="n">divide_by_h</span>


            <span class="c1"># working only with one class</span>
            <span class="n">Cmin</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">C_state_here</span><span class="p">)</span>

            <span class="n">deposition</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">C_state_here</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">C_settling</span>

            <span class="n">source_term</span> <span class="o">=</span> <span class="n">hc_by_dx_dx</span> <span class="o">+</span> <span class="n">hc_by_dy_dy</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">hc_by_dx_dy</span> <span class="o">+</span> <span class="n">erosion</span> <span class="o">-</span> <span class="n">deposition</span>

            <span class="n">d_by_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">xflux_west</span> <span class="o">-</span> <span class="n">xflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">+</span> <span class="p">(</span><span class="n">yflux_south</span> <span class="o">-</span> <span class="n">yflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">+</span> <span class="n">source_term</span>

            <span class="c1"># previous derivatives</span>
            <span class="n">oldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldGradients_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">oldOldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldOldGradients_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

            <span class="n">Out</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># if timeScheme is Euler do:</span>
                <span class="n">Out</span> <span class="o">=</span> <span class="n">C_state_here</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">d_by_dt</span>

            <span class="k">elif</span> <span class="n">pred_or_corrector</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># if time scheme is predictor</span>
                <span class="n">Out</span> <span class="o">=</span> <span class="n">C_state_here</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">12.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">23.</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">-</span> <span class="mf">16.</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="mf">5.</span><span class="o">*</span><span class="n">oldOldies</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">pred_or_corrector</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># if time scheme is corrector</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictedGradients_Sed</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="c1"># corrector step</span>
                <span class="n">Out</span> <span class="o">=</span> <span class="n">C_state_here</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">24.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">9.</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">+</span> <span class="mf">19.</span><span class="o">*</span><span class="n">predicted</span> <span class="o">-</span> <span class="mf">5.</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">*</span><span class="n">oldOldies</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">NewState_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">Out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt_Sed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">d_by_dt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">erosion_Sed</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">erosion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deposition_Sed</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">deposition</span></div>



<div class="viewcode-block" id="Solver.Pass3Bous">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Pass3Bous">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pass3Bous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pred_or_corrector</span><span class="p">:</span><span class="n">ti</span><span class="o">.</span><span class="n">i32</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Time-update step (Pass3) for the Boussinesq model:</span>
<span class="sd">          - Updates wave height, hu, hv, concentration.</span>
<span class="sd">          - Incorporates dispersion terms, bed slope, friction, infiltration, </span>
<span class="sd">            and wave breaking if enabled.</span>
<span class="sd">          - Uses a predictor-corrector approach for higher-order accuracy.</span>

<span class="sd">        Args:</span>
<span class="sd">            pred_or_corrector (int): Stage in predictor-corrector scheme (1 =&gt; predictor, 2 =&gt; corrector).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Bottom</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">static</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">)</span>
        <span class="n">zro</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
        <span class="c1"># PASS 3 - Calculus of fluxes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="k">continue</span>
                <span class="c1"># Load values from txBottom using index</span>
                <span class="n">B_here</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="c1">#</span>
                <span class="c1"># Load values from txState using index</span>
                <span class="n">in_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="c1"># w, hu and hv (cell avgs, evaluated here)</span>
                <span class="n">in_state_here_UV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">h_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">B_here</span> <span class="c1"># h = w - B</span>

                <span class="c1"># Calculate local h,w</span>
                <span class="n">B_west</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">eta_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">h_west</span> <span class="o">=</span> <span class="n">eta_west</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">eta_east</span> <span class="o">-</span> <span class="n">B_east</span>

                <span class="c1"># if dry and surrounded by dry, then stay dry - no need to calc</span>
                <span class="n">h_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
                <span class="k">if</span> <span class="n">h_here</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">h_east</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_west</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="k">continue</span>
                <span class="n">h_min</span> <span class="o">=</span> <span class="n">zro</span>
                <span class="n">h_min</span><span class="o">.</span><span class="n">y</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_east</span><span class="p">)</span>
                <span class="n">h_min</span><span class="o">.</span><span class="n">w</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_west</span><span class="p">)</span>

                <span class="c1"># Load values from txXFlux and txYFlux using idx</span>
                <span class="n">xflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># at i+1/2</span>
                <span class="n">xflux_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># at i-1/2</span>
               
                <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                
                <span class="n">F_star</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Psi1x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Psi2x</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="n">d_here</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_here</span> <span class="c1">#</span>
                <span class="n">near_dry</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># OPTIMIZ: only proceed if not near an initially dry cell</span>
                <span class="k">if</span> <span class="n">near_dry</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
                    <span class="n">d2_here</span> <span class="o">=</span> <span class="n">d_here</span> <span class="o">*</span> <span class="n">d_here</span>
                    <span class="n">d3_here</span> <span class="o">=</span> <span class="n">d2_here</span> <span class="o">*</span> <span class="n">d_here</span>

                    <span class="n">in_state_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="c1">#in_state_up = self.State[i,j+1].xyz</span>
                    <span class="c1">#in_state_down = self.State[i,j-1].xyz</span>
                    <span class="c1">#in_state_up_left = self.State[i-1,j+1].xyz</span>
                    <span class="c1">#in_state_up_right = self.State[i+1,j+1].xyz</span>
                    <span class="c1">#in_state_down_left = self.State[i-1,j-1].xyz</span>
                    <span class="c1">#in_state_down_right = self.State[i+1,j-1].xyz</span>

                    <span class="n">F_G_star_oldOldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_G_star_oldOldGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>

                    <span class="c1"># Calculate &quot;d&quot; stencil</span>
                    <span class="n">d_left</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_west</span>
                    <span class="n">d_right</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_east</span>
                
                    <span class="n">d_left_left</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mf">0.0</span> <span class="p">,</span><span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">d_right_right</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>

                    <span class="c1"># Calculate &quot;eta&quot; stencil</span>
                    <span class="n">eta_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_left</span> <span class="o">=</span> <span class="n">in_state_left</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_right</span> <span class="o">=</span> <span class="n">in_state_right</span><span class="o">.</span><span class="n">x</span>
                    <span class="c1">#eta_down = in_state_down.x</span>
                    <span class="c1">#eta_up = in_state_up.x</span>

                    <span class="n">eta_left_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_right_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="c1">#eta_down_down = self.State[i,j-2].x</span>
                    <span class="c1">#eta_up_up = self.State[i,j+2].x</span>

                    <span class="c1">#eta_up_left = in_state_up_left.x</span>
                    <span class="c1">#eta_up_right = in_state_up_right.x</span>
                    <span class="c1">#eta_down_left = in_state_down_left.x</span>
                    <span class="c1">#eta_down_right = in_state_down_right.x</span>

                    <span class="c1"># replace with 4th order when dispersion is included</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">eta_right_right</span> <span class="o">+</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">eta_right</span> <span class="o">-</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">eta_left</span> <span class="o">+</span> <span class="n">eta_left_left</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">/</span> <span class="mf">12.0</span>
                    <span class="c1">#detady = (-eta_up_up + 8.0 * eta_up - 8.0 * eta_down + eta_down_down) * self.one_over_dy / 12.0</span>

                    <span class="c1">#u_up = in_state_up.y</span>
                    <span class="c1">#u_down = in_state_down.y</span>
                    <span class="n">u_right</span> <span class="o">=</span> <span class="n">in_state_right</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_left</span> <span class="o">=</span> <span class="n">in_state_left</span><span class="o">.</span><span class="n">y</span>
                    <span class="c1">#u_up_right = in_state_up_right.y</span>
                    <span class="c1">#u_down_right = in_state_down_right.y</span>
                    <span class="c1">#u_up_left = in_state_up_left.y</span>
                    <span class="c1">#u_down_left = in_state_down_left.y</span>

                    <span class="n">dd_by_dx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">d_right_right</span> <span class="o">+</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">d_right</span> <span class="o">-</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">d_left</span> <span class="o">+</span> <span class="n">d_left_left</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">/</span> <span class="mf">12.0</span>

                    <span class="c1">#eta_by_dx_dy = 0.25 * self.one_over_dx * self.one_over_dy * (eta_up_right - eta_down_right - eta_up_left + eta_down_left)</span>
                    <span class="n">eta_by_dx_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_here</span> <span class="o">+</span> <span class="n">eta_left</span><span class="p">)</span>
                    <span class="c1">#eta_by_dy_dy = self.one_over_d2y * (eta_up - 2.0 * eta_here + eta_down)</span>

                    <span class="n">F_star</span> <span class="o">=</span><span class="mf">0.0</span>

                    <span class="n">Psi1x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef_g</span> <span class="o">*</span> <span class="n">d3_here</span> <span class="o">*</span> <span class="p">((</span><span class="n">eta_right_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_right</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_left</span> <span class="o">-</span> <span class="n">eta_left_left</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d3x</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">Psi2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef_g</span> <span class="o">*</span> <span class="n">d2_here</span> <span class="o">*</span> <span class="p">(</span><span class="n">dd_by_dx</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_by_dx_dx</span> <span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">F_star</span> <span class="o">-</span> <span class="n">F_G_star_oldOldies</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="mf">0.5</span>

                <span class="n">friction_here</span> <span class="o">=</span>  <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">friction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BottomFriction</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">friction_</span> <span class="o">=</span> <span class="n">FrictionCalc</span><span class="p">(</span><span class="n">in_state_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">h_here</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">friction_here</span><span class="p">)</span>

                <span class="c1"># Pressure stencil calculations</span>
                <span class="n">P_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">press_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_right</span> <span class="o">-</span> <span class="n">P_left</span><span class="p">)</span>

                <span class="c1"># Calculate scalar transport additions</span>
                <span class="n">C_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>

                <span class="n">C_state_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="c1">#C_state_up = self.State[i,j+1].w</span>
                <span class="c1">#C_state_down = self.State[i,j-1].w</span>
                <span class="c1">#C_state_up_left = self.State[i-1,j+1].w</span>
                <span class="c1">#C_state_up_right = self.State[i+1,j+1].w</span>
                <span class="c1">#C_state_down_left = self.State[i-1,j-1].w</span>
                <span class="c1">#C_state_down_right = self.State[i+1,j-1].w</span>

                <span class="n">Dxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>
                <span class="c1">#Dxy = self.whiteWaterDispersion</span>
                <span class="c1">#Dyy = self.whiteWaterDispersion</span>

                <span class="n">hc_by_dx_dx</span> <span class="o">=</span> <span class="n">Dxx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">C_state_left</span><span class="p">)</span>
                <span class="c1">#hc_by_dy_dy = Dyy * self.one_over_d2y * (C_state_up - 2.0 * in_state_here.a + C_state_down)</span>
                <span class="c1">#hc_by_dx_dy = 0.25 * Dxy * self.one_over_dxdy * (C_state_up_right - C_state_up_left - C_state_down_right + C_state_down_left)</span>

                <span class="n">c_dissipation</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDecayRate</span> <span class="o">*</span> <span class="n">C_state_here</span>

                <span class="c1"># calculate breaking dissipation</span>
                <span class="n">breaking_x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">breaking_y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">breaking_B</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useBreakingModel</span><span class="p">:</span>
                    <span class="n">breaking_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="c1">#breaking front parameter, non-breaking [0 - 1] breaking</span>
                    <span class="n">nu_flux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">nu_flux_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">nu_flux_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                
                    <span class="n">dPdxx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_right</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">nu_flux_left</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                    <span class="n">dPdyx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_right</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">nu_flux_left</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                    
                    <span class="k">if</span> <span class="n">near_dry</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">breaking_x</span> <span class="o">=</span> <span class="n">dPdxx</span> 

                <span class="c1"># fix slope near shoreline</span>
                <span class="k">if</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_here</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>

                <span class="n">overflow_dry</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">B_here</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="p">:</span>
                    <span class="n">overflow_dry</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">infiltrationRate</span>  <span class="c1">#hydraulic conductivity of coarse, unsaturated sand</span>

                <span class="n">sx</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detadx</span> <span class="o">-</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">friction_</span> <span class="o">+</span> <span class="n">breaking_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">Psi1x</span> <span class="o">+</span> <span class="n">Psi2x</span><span class="p">)</span> <span class="o">+</span> <span class="n">press_x</span>


                <span class="n">source_term</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">overflow_dry</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">hc_by_dx_dx</span> <span class="o">+</span> <span class="n">c_dissipation</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">d_by_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">xflux_west</span> <span class="o">-</span> <span class="n">xflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">+</span> <span class="n">source_term</span>

                <span class="c1"># previous derivatives</span>
                <span class="n">oldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">oldOldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldOldGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">newState</span> <span class="o">=</span> <span class="n">zro</span>   <span class="c1"># w , hu, hv ,hc</span>
                <span class="n">F_G_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">F_star</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># if timeScheme is Euler do:</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">d_by_dt</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">12.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">23.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">-</span> <span class="mf">16.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictedGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">24.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">9.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">+</span> <span class="mf">19.0</span><span class="o">*</span><span class="n">predicted</span> <span class="o">-</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span><span class="kc">True</span> <span class="p">:</span>
                    <span class="c1"># add breaking source</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">newState</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">breaking_B</span><span class="p">)</span> <span class="c1"># use the B value from Kennedy et al as a foam intensity</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                    <span class="n">contaminent_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ContSource</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newState</span><span class="o">.</span><span class="n">w</span> <span class="o">+</span> <span class="n">contaminent_source</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_by_dt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_G_here</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                    <span class="k">continue</span>

                <span class="c1"># Load values from txBottom using index</span>
                <span class="n">B_here</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="c1">#</span>

                <span class="c1"># Load values from txState using index</span>
                <span class="n">in_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="c1"># w, hu and hv (cell avgs, evaluated here)</span>
                <span class="n">in_state_here_UV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">h_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">B_here</span> <span class="c1"># h = w - B</span>

                <span class="c1"># Calculate local h,w</span>
                <span class="n">B_south</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">B_north</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">B_west</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">B_east</span> <span class="o">=</span> <span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="n">eta_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">x</span>

                <span class="n">eta_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">eta_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">h_west</span> <span class="o">=</span> <span class="n">eta_west</span> <span class="o">-</span> <span class="n">B_west</span>
                <span class="n">h_east</span> <span class="o">=</span> <span class="n">eta_east</span> <span class="o">-</span> <span class="n">B_east</span>
                <span class="n">h_north</span> <span class="o">=</span> <span class="n">eta_north</span> <span class="o">-</span> <span class="n">B_north</span>
                <span class="n">h_south</span> <span class="o">=</span> <span class="n">eta_south</span> <span class="o">-</span> <span class="n">B_south</span>

                <span class="c1"># if dry and surrounded by dry, then stay dry - no need to calc</span>
                <span class="n">h_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
                <span class="k">if</span> <span class="n">h_here</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">h_north</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_east</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_south</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_west</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">zro</span>
                        <span class="k">continue</span>

                <span class="n">h_min</span> <span class="o">=</span> <span class="n">zro</span>
                <span class="n">h_min</span><span class="o">.</span><span class="n">x</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_north</span><span class="p">)</span>
                <span class="n">h_min</span><span class="o">.</span><span class="n">y</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_east</span><span class="p">)</span>
                <span class="n">h_min</span><span class="o">.</span><span class="n">z</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_south</span><span class="p">)</span>
                <span class="n">h_min</span><span class="o">.</span><span class="n">w</span><span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h_here</span><span class="p">,</span> <span class="n">h_west</span><span class="p">)</span>

                <span class="c1"># Load values from txXFlux and txYFlux using idx</span>
                <span class="n">xflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># at i+1/2</span>
                <span class="n">xflux_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># at i-1/2</span>
                <span class="n">yflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># at j+1/2</span>
                <span class="n">yflux_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># at j-1/2</span>

                <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="n">detady</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">eta_north</span> <span class="o">-</span> <span class="n">eta_south</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                <span class="n">F_star</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">G_star</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Psi1x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Psi2x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Psi1y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">Psi2y</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="n">d_here</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_here</span> <span class="c1">#</span>
                <span class="n">near_dry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># OPTIMIZ: only proceed if not near an initially dry cell</span>
                <span class="k">if</span> <span class="n">near_dry</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
                    <span class="n">d2_here</span> <span class="o">=</span> <span class="n">d_here</span> <span class="o">*</span> <span class="n">d_here</span>
                    <span class="n">d3_here</span> <span class="o">=</span> <span class="n">d2_here</span> <span class="o">*</span> <span class="n">d_here</span>

                    <span class="n">in_state_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_up_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_up_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_down_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>
                    <span class="n">in_state_down_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>

                    <span class="n">F_G_star_oldOldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_G_star_oldOldGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span>

                    <span class="c1"># Calculate &quot;d&quot; stencil</span>
                    <span class="n">d_left</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_west</span>
                    <span class="n">d_right</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_east</span>
                    <span class="n">d_down</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_south</span>
                    <span class="n">d_up</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_north</span>

                    <span class="n">d_left_left</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mf">0.0</span> <span class="p">,</span><span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">d_right_right</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">d_down_down</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">d_up_up</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>

                    <span class="c1"># Calculate &quot;eta&quot; stencil</span>
                    <span class="n">eta_here</span> <span class="o">=</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_left</span> <span class="o">=</span> <span class="n">in_state_left</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_right</span> <span class="o">=</span> <span class="n">in_state_right</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_down</span> <span class="o">=</span> <span class="n">in_state_down</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_up</span> <span class="o">=</span> <span class="n">in_state_up</span><span class="o">.</span><span class="n">x</span>

                    <span class="n">eta_left_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_right_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_down_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_up_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                    <span class="n">eta_up_left</span> <span class="o">=</span> <span class="n">in_state_up_left</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_up_right</span> <span class="o">=</span> <span class="n">in_state_up_right</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_down_left</span> <span class="o">=</span> <span class="n">in_state_down_left</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">eta_down_right</span> <span class="o">=</span> <span class="n">in_state_down_right</span><span class="o">.</span><span class="n">x</span>

                    <span class="c1"># replace with 4th order when dispersion is included</span>
                    <span class="c1">#detadx = 1.0 / 12.0 * (eta_left_left - 8.0 * eta_left + 8.0 * eta_right + eta_right_right) * self.one_over_dx</span>
                    <span class="c1">#detady = 1.0 / 12.0 * (eta_down_down - 8.0 * eta_down + 8.0 * eta_up + eta_up_up) * self.one_over_dy</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">eta_right_right</span> <span class="o">+</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">eta_right</span> <span class="o">-</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">eta_left</span> <span class="o">+</span> <span class="n">eta_left_left</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">/</span> <span class="mf">12.0</span>
                    <span class="n">detady</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">eta_up_up</span> <span class="o">+</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">eta_up</span> <span class="o">-</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">eta_down</span> <span class="o">+</span> <span class="n">eta_down_down</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">/</span> <span class="mf">12.0</span>

                    <span class="n">u_up</span> <span class="o">=</span> <span class="n">in_state_up</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_down</span> <span class="o">=</span> <span class="n">in_state_down</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_right</span> <span class="o">=</span> <span class="n">in_state_right</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_left</span> <span class="o">=</span> <span class="n">in_state_left</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_up_right</span> <span class="o">=</span> <span class="n">in_state_up_right</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_down_right</span> <span class="o">=</span> <span class="n">in_state_down_right</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_up_left</span> <span class="o">=</span> <span class="n">in_state_up_left</span><span class="o">.</span><span class="n">y</span>
                    <span class="n">u_down_left</span> <span class="o">=</span> <span class="n">in_state_down_left</span><span class="o">.</span><span class="n">y</span>

                    <span class="n">v_up</span> <span class="o">=</span> <span class="n">in_state_up</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">v_down</span> <span class="o">=</span> <span class="n">in_state_down</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">v_right</span> <span class="o">=</span> <span class="n">in_state_right</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">v_left</span> <span class="o">=</span> <span class="n">in_state_left</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">v_up_right</span> <span class="o">=</span> <span class="n">in_state_up_right</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">v_down_right</span> <span class="o">=</span> <span class="n">in_state_down_right</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">v_up_left</span> <span class="o">=</span> <span class="n">in_state_up_left</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">v_down_left</span> <span class="o">=</span> <span class="n">in_state_down_left</span><span class="o">.</span><span class="n">z</span>

                    <span class="n">dd_by_dx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">d_right_right</span> <span class="o">+</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">d_right</span> <span class="o">-</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">d_left</span> <span class="o">+</span> <span class="n">d_left_left</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">/</span> <span class="mf">12.0</span>
                    <span class="n">dd_by_dy</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">d_up_up</span> <span class="o">+</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">d_up</span> <span class="o">-</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="n">d_down</span> <span class="o">+</span> <span class="n">d_down_down</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">/</span> <span class="mf">12.0</span>
                    <span class="n">eta_by_dx_dy</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta_up_right</span> <span class="o">-</span> <span class="n">eta_down_right</span> <span class="o">-</span> <span class="n">eta_up_left</span> <span class="o">+</span> <span class="n">eta_down_left</span><span class="p">)</span>
                    <span class="n">eta_by_dx_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_here</span> <span class="o">+</span> <span class="n">eta_left</span><span class="p">)</span>
                    <span class="n">eta_by_dy_dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2y</span> <span class="o">*</span> <span class="p">(</span><span class="n">eta_up</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_here</span> <span class="o">+</span> <span class="n">eta_down</span><span class="p">)</span>

                    <span class="n">F_star</span> <span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_here</span> <span class="o">*</span> <span class="p">(</span><span class="n">dd_by_dx</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_up</span> <span class="o">-</span> <span class="n">v_down</span><span class="p">)</span> <span class="o">+</span>\
                                                    <span class="n">dd_by_dy</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_right</span> <span class="o">-</span> <span class="n">v_left</span><span class="p">))</span> <span class="o">+</span>\
                                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d2_here</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one_over_dxdy</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">*</span>\
                                                    <span class="p">(</span><span class="n">v_up_right</span><span class="o">-</span> <span class="n">v_down_right</span> <span class="o">-</span> <span class="n">v_up_left</span> <span class="o">+</span> <span class="n">v_down_left</span><span class="p">)</span>

                    <span class="n">G_star</span> <span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_here</span> <span class="o">*</span> <span class="p">(</span><span class="n">dd_by_dx</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_up</span> <span class="o">-</span> <span class="n">u_down</span><span class="p">)</span> <span class="o">+</span>\
                                                    <span class="n">dd_by_dy</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_right</span> <span class="o">-</span> <span class="n">u_left</span><span class="p">))</span> <span class="o">+</span>\
                                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Bcoef</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d2_here</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one_over_dxdy</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">*</span>\
                                                    <span class="p">(</span><span class="n">u_up_right</span> <span class="o">-</span> <span class="n">u_down_right</span> <span class="o">-</span> <span class="n">u_up_left</span> <span class="o">+</span> <span class="n">u_down_left</span><span class="p">)</span>

                    <span class="n">Psi1x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef_g</span> <span class="o">*</span> <span class="n">d3_here</span> <span class="o">*</span> <span class="p">((</span><span class="n">eta_right_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_right</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_left</span> <span class="o">-</span> <span class="n">eta_left_left</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d3x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">eta_up_right</span> <span class="o">-</span> <span class="n">eta_up_left</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_right</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_left</span> <span class="o">+</span> <span class="n">eta_down_right</span> <span class="o">-</span> <span class="n">eta_down_left</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2y</span><span class="p">))</span>
                    <span class="n">Psi2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef_g</span> <span class="o">*</span> <span class="n">d2_here</span> <span class="o">*</span> <span class="p">(</span><span class="n">dd_by_dx</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_by_dx_dx</span> <span class="o">+</span> <span class="n">eta_by_dy_dy</span><span class="p">)</span> <span class="o">+</span> <span class="n">dd_by_dy</span> <span class="o">*</span> <span class="n">eta_by_dx_dy</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">F_star</span> <span class="o">-</span> <span class="n">F_G_star_oldOldies</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="mf">0.5</span>
                    <span class="n">Psi1y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef_g</span> <span class="o">*</span> <span class="n">d3_here</span> <span class="o">*</span> <span class="p">((</span><span class="n">eta_up_up</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_up</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_down</span> <span class="o">-</span> <span class="n">eta_down_down</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d3y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">eta_up_right</span> <span class="o">+</span> <span class="n">eta_up_left</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_up</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_down</span> <span class="o">-</span> <span class="n">eta_down_right</span> <span class="o">-</span> <span class="n">eta_down_left</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span><span class="p">))</span>
                    <span class="n">Psi2y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bcoef_g</span> <span class="o">*</span> <span class="n">d2_here</span> <span class="o">*</span> <span class="p">(</span><span class="n">dd_by_dy</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">eta_by_dy_dy</span> <span class="o">+</span> <span class="n">eta_by_dx_dx</span><span class="p">)</span> <span class="o">+</span> <span class="n">dd_by_dx</span> <span class="o">*</span> <span class="n">eta_by_dx_dy</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">G_star</span> <span class="o">-</span> <span class="n">F_G_star_oldOldies</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="mf">0.5</span>

                <span class="n">friction_here</span> <span class="o">=</span>  <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">friction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BottomFriction</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">friction_</span> <span class="o">=</span> <span class="n">FrictionCalc</span><span class="p">(</span><span class="n">in_state_here</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">h_here</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">friction_here</span><span class="p">)</span>

                <span class="c1"># Pressure stencil calculations</span>
                <span class="n">P_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">P_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShipPressure</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">press_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_right</span> <span class="o">-</span> <span class="n">P_left</span><span class="p">)</span>
                <span class="n">press_y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_over_dy</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_up</span> <span class="o">-</span> <span class="n">P_down</span><span class="p">)</span>

                <span class="c1"># Calculate scalar transport additions</span>
                <span class="n">C_state_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>

                <span class="n">C_state_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_up_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_up_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_down_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>
                <span class="n">C_state_down_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span>

                <span class="n">Dxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>
                <span class="n">Dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>
                <span class="n">Dyy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDispersion</span>

                <span class="n">hc_by_dx_dx</span> <span class="o">=</span> <span class="n">Dxx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2x</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_right</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">C_state_left</span><span class="p">)</span>
                <span class="n">hc_by_dy_dy</span> <span class="o">=</span> <span class="n">Dyy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_d2y</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_up</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">in_state_here</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">C_state_down</span><span class="p">)</span>
                <span class="n">hc_by_dx_dy</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">Dxy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dxdy</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_state_up_right</span> <span class="o">-</span> <span class="n">C_state_up_left</span> <span class="o">-</span> <span class="n">C_state_down_right</span> <span class="o">+</span> <span class="n">C_state_down_left</span><span class="p">)</span>

                <span class="n">c_dissipation</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">whiteWaterDecayRate</span> <span class="o">*</span> <span class="n">C_state_here</span>

                <span class="c1"># calculate breaking dissipation</span>
                <span class="n">breaking_x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">breaking_y</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">breaking_B</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useBreakingModel</span><span class="p">:</span>
                    <span class="n">breaking_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="c1">#breaking front parameter, non-breaking [0 - 1] breaking</span>
                    <span class="n">nu_flux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">nu_flux_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">nu_flux_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">nu_flux_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">nu_flux_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">dPdxx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_right</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">nu_flux_left</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                    <span class="n">dPdyx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_right</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">nu_flux_left</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                    <span class="n">dPdyy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_up</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">nu_flux_down</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                    <span class="n">dQdxx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_right</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">nu_flux_left</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                    <span class="n">dQdxy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_up</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">nu_flux_down</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>
                    <span class="n">dQdyy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu_flux_up</span><span class="o">.</span><span class="n">w</span> <span class="o">-</span> <span class="n">nu_flux_down</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                    <span class="k">if</span> <span class="n">near_dry</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">breaking_x</span> <span class="o">=</span> <span class="n">dPdxx</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dPdyy</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dQdxy</span>
                        <span class="n">breaking_y</span> <span class="o">=</span> <span class="n">dQdyy</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dPdyx</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dQdxx</span>

                <span class="c1"># fix slope near shoreline</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">h_min</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_min</span><span class="o">.</span><span class="n">z</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="p">):</span>
                    <span class="n">detady</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detady</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_here</span> <span class="o">-</span> <span class="n">eta_south</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="p">:</span>
                    <span class="n">detady</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_north</span> <span class="o">-</span> <span class="n">eta_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                <span class="k">if</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="ow">and</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span><span class="o">&lt;=</span><span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">h_cut</span><span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_here</span> <span class="o">-</span> <span class="n">eta_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="k">elif</span> <span class="n">h_min</span><span class="o">.</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">h_cut</span> <span class="p">:</span>
                    <span class="n">detadx</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">eta_east</span> <span class="o">-</span> <span class="n">eta_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>

                <span class="n">overflow_dry</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">B_here</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="p">:</span>
                    <span class="n">overflow_dry</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">infiltrationRate</span>  <span class="c1">#hydraulic conductivity of coarse, unsaturated sand</span>

                <span class="n">sx</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detadx</span> <span class="o">-</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">friction_</span> <span class="o">+</span> <span class="n">breaking_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">Psi1x</span> <span class="o">+</span> <span class="n">Psi2x</span><span class="p">)</span> <span class="o">+</span> <span class="n">press_x</span>
                <span class="n">sy</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detady</span> <span class="o">-</span> <span class="n">in_state_here</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">friction_</span> <span class="o">+</span> <span class="n">breaking_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">Psi1y</span> <span class="o">+</span> <span class="n">Psi2y</span><span class="p">)</span> <span class="o">+</span> <span class="n">press_y</span>

                <span class="n">source_term</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">overflow_dry</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">hc_by_dx_dx</span> <span class="o">+</span> <span class="n">hc_by_dy_dy</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">hc_by_dx_dy</span> <span class="o">+</span> <span class="n">c_dissipation</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">d_by_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">xflux_west</span> <span class="o">-</span> <span class="n">xflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span> <span class="o">+</span> <span class="p">(</span><span class="n">yflux_south</span> <span class="o">-</span> <span class="n">yflux_here</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span> <span class="o">+</span> <span class="n">source_term</span>

                <span class="c1"># previous derivatives</span>
                <span class="n">oldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">oldOldies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldOldGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">newState</span> <span class="o">=</span> <span class="n">zro</span>   <span class="c1"># w , hu, hv ,hc</span>
                <span class="n">F_G_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">F_star</span><span class="p">,</span> <span class="n">G_star</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeScheme</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># if timeScheme is Euler do:</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="n">d_by_dt</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">12.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">23.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">-</span> <span class="mf">16.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">pred_or_corrector</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictedGradients</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">newState</span> <span class="o">=</span> <span class="n">in_state_here_UV</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="mf">24.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">9.0</span><span class="o">*</span><span class="n">d_by_dt</span> <span class="o">+</span> <span class="mf">19.0</span><span class="o">*</span><span class="n">predicted</span> <span class="o">-</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">oldies</span> <span class="o">+</span> <span class="n">oldOldies</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span><span class="kc">True</span> <span class="p">:</span>
                    <span class="c1"># add breaking source</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">newState</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">breaking_B</span><span class="p">)</span> <span class="c1"># use the B value from Kennedy et al as a foam intensity</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">showBreaking</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                    <span class="n">contaminent_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ContSource</span><span class="p">[</span><span class="n">i</span> <span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">newState</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newState</span><span class="o">.</span><span class="n">w</span> <span class="o">+</span> <span class="n">contaminent_source</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_by_dt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictedF_G_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_G_here</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newState</span></div>




<div class="viewcode-block" id="Solver.Pass_Breaking">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Pass_Breaking">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pass_Breaking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="p">:</span><span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wave-breaking model step (used if useBreakingModel == True):</span>
<span class="sd">          - Applies Kennedy et al. or similar wave breaking logic to compute local </span>
<span class="sd">            dissipation flux and update the Breaking field. </span>
<span class="sd">          - Incorporates eddy viscosity effects from breaking.</span>

<span class="sd">        Args:</span>
<span class="sd">            time (float): Current simulation time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
                    <span class="c1">#Compute the coordinates of the neighbors</span>
                    <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">xflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">xflux_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                    <span class="c1">#P_south = self.State[i,downIdx].y</span>
                    <span class="n">P_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
                    <span class="c1">#P_north = self.State[i,upIdx].y</span>

                    <span class="n">detadt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                    <span class="c1"># Look the dominant direction of flow, and look at the three cells on that 3*3 cube</span>
                    <span class="n">t_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">t2</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">t3</span> <span class="o">=</span> <span class="mf">0.0</span>

                    
                    <span class="k">if</span> <span class="n">P_here</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                            <span class="c1">#t2 = self.Breaking[leftIdx,upIdx].x</span>
                            <span class="c1">#t3 = self.Breaking[leftIdx,downIdx].x</span>
                    <span class="k">else</span><span class="p">:</span>
                            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                            <span class="c1">#t2 = self.Breaking[rightIdx,upIdx].x</span>
                            <span class="c1">#t3 = self.Breaking[rightIdx,downIdx].x</span>
                    

                    <span class="c1">#t_here = ti.max(t_here, ti.max(t1, ti.max(t2, t3)))</span>
                    <span class="n">t_here</span> <span class="o">=</span> <span class="n">t1</span>

                    <span class="n">dPdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xflux_here</span> <span class="o">-</span> <span class="n">xflux_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>

                    <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">eta_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="n">h_here</span> <span class="o">=</span> <span class="n">eta_here</span> <span class="o">-</span> <span class="n">B_here</span>
                    <span class="n">c_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span><span class="p">)</span>
                    <span class="n">h2</span> <span class="o">=</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">h_here</span>
                    <span class="n">divide_by_h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">/</span> <span class="p">(</span><span class="n">h2</span> <span class="o">+</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>

                    <span class="c1"># Kennedy et al breaking model, default parameters</span>
                    <span class="c1"># Transition time</span>
                    <span class="n">T_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_star_coef</span><span class="o">*</span><span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h_here</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
                    <span class="n">dzdt_I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_I_coef</span><span class="o">*</span><span class="n">c_here</span>
                    <span class="n">dzdt_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_F_coef</span><span class="o">*</span><span class="n">c_here</span>

                    <span class="n">dzdt_star</span> <span class="o">=</span> <span class="mf">0.0</span>

                    <span class="k">if</span> <span class="n">t_here</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                        <span class="n">dzdt_star</span> <span class="o">=</span> <span class="n">dzdt_I</span>
                    <span class="k">elif</span> <span class="n">time</span> <span class="o">-</span> <span class="n">t_here</span> <span class="o">&lt;=</span> <span class="n">T_star</span><span class="p">:</span>
                        <span class="n">dzdt_star</span> <span class="o">=</span> <span class="n">dzdt_I</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">t_here</span><span class="p">)</span> <span class="o">/</span> <span class="n">T_star</span> <span class="o">*</span> <span class="p">(</span><span class="n">dzdt_F</span> <span class="o">-</span> <span class="n">dzdt_I</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dzdt_star</span> <span class="o">=</span> <span class="n">dzdt_F</span>

                    <span class="n">B_Breaking</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="n">detadt</span> <span class="o">&lt;</span> <span class="n">dzdt_star</span> <span class="p">:</span>
                        <span class="n">t_here</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">elif</span> <span class="n">detadt</span> <span class="o">&gt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dzdt_star</span><span class="p">:</span>
                        <span class="n">B_Breaking</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="k">if</span> <span class="n">t_here</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="p">:</span>
                            <span class="n">t_here</span> <span class="o">=</span> <span class="n">time</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">B_Breaking</span> <span class="o">=</span> <span class="n">detadt</span> <span class="o">/</span> <span class="n">dzdt_star</span> <span class="o">-</span><span class="mf">1.0</span>
                        <span class="k">if</span> <span class="n">t_here</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                            <span class="n">t_here</span> <span class="o">=</span> <span class="n">time</span>

                    <span class="n">nu_breaking</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">B_Breaking</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_breaking</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detadt</span><span class="p">)</span>

                    <span class="c1"># Smagorinsky subgrid eddy viscosity</span>
                    <span class="n">Smag_cm</span> <span class="o">=</span> <span class="mf">0.04</span>
                    <span class="c1">#nu_Smag = Smag_cm * self.dx * self.dy * ti.sqrt(2. * dPdx * dPdx + 2. * dQdy * dQdy + (dPdy + dQdx) * (dPdy + dQdx)) * divide_by_h  # temporary, needs to be corrected to strain rate, right now has extra dHdx terms</span>
                    <span class="n">nu_Smag</span> <span class="o">=</span> <span class="n">Smag_cm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">dPdx</span> <span class="o">*</span> <span class="n">dPdx</span> <span class="p">)</span> <span class="o">*</span> <span class="n">divide_by_h</span>  <span class="c1"># </span>


                    <span class="c1"># sum eddy viscosities and calc fluxes</span>
                    <span class="n">nu_total</span> <span class="o">=</span> <span class="n">nu_breaking</span> <span class="o">+</span> <span class="n">nu_Smag</span>

                    <span class="n">nu_dPdx</span> <span class="o">=</span> <span class="n">nu_total</span> <span class="o">*</span> <span class="n">dPdx</span>
                    
                   
                    <span class="n">nu_flux</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">nu_dPdx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                    <span class="n">Bvalues</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">t_here</span><span class="p">,</span> <span class="n">nu_breaking</span><span class="p">,</span> <span class="n">B_Breaking</span><span class="p">,</span> <span class="n">nu_Smag</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu_flux</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bvalues</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">:</span>
                <span class="c1">#Compute the coordinates of the neighbors</span>
                <span class="n">rightIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">upIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">leftIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">downIdx</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="n">xflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">xflux_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFlux</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">yflux_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">yflux_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">P_south</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
                <span class="n">P_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
                <span class="n">P_north</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>

                <span class="n">Q_west</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">z</span>
                <span class="n">Q_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">z</span>
                <span class="n">Q_east</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">z</span>

                <span class="n">detadt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dU_by_dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="c1"># Look the dominant direction of flow, and look at the three cells on that 3*3 cube</span>
                <span class="n">t_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">t3</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">P_here</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ti</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Q_here</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">P_here</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Q_here</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">downIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">rightIdx</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">leftIdx</span><span class="p">,</span><span class="n">upIdx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>

                <span class="n">t_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t_here</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">)))</span>

                <span class="n">dPdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xflux_here</span> <span class="o">-</span> <span class="n">xflux_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="n">dPdy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_north</span> <span class="o">-</span> <span class="n">P_south</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                <span class="n">dQdx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q_east</span> <span class="o">-</span> <span class="n">Q_west</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dx</span>
                <span class="n">dQdy</span> <span class="o">=</span> <span class="p">(</span><span class="n">yflux_here</span> <span class="o">-</span> <span class="n">yflux_south</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_over_dy</span>

                <span class="n">B_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">eta_here</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">h_here</span> <span class="o">=</span> <span class="n">eta_here</span> <span class="o">-</span> <span class="n">B_here</span>
                <span class="n">c_here</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">h_here</span><span class="p">)</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">h_here</span>
                <span class="n">divide_by_h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">/</span> <span class="p">(</span><span class="n">h2</span> <span class="o">+</span> <span class="n">ti</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>

                <span class="c1"># Kennedy et al breaking model, default parameters</span>
                <span class="n">T_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_star_coef</span><span class="o">*</span><span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h_here</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
                <span class="n">dzdt_I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_I_coef</span><span class="o">*</span><span class="n">c_here</span>
                <span class="n">dzdt_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dzdt_F_coef</span><span class="o">*</span><span class="n">c_here</span>

                <span class="n">dzdt_star</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="n">t_here</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                    <span class="n">dzdt_star</span> <span class="o">=</span> <span class="n">dzdt_I</span>
                <span class="k">elif</span> <span class="n">time</span> <span class="o">-</span> <span class="n">t_here</span> <span class="o">&lt;=</span> <span class="n">T_star</span><span class="p">:</span>
                    <span class="n">dzdt_star</span> <span class="o">=</span> <span class="n">dzdt_I</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">t_here</span><span class="p">)</span> <span class="o">/</span> <span class="n">T_star</span> <span class="o">*</span> <span class="p">(</span><span class="n">dzdt_F</span> <span class="o">-</span> <span class="n">dzdt_I</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dzdt_star</span> <span class="o">=</span> <span class="n">dzdt_F</span>

                <span class="n">B_Breaking</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">detadt</span> <span class="o">&lt;</span> <span class="n">dzdt_star</span> <span class="p">:</span>
                    <span class="n">t_here</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">detadt</span> <span class="o">&gt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dzdt_star</span><span class="p">:</span>
                    <span class="n">B_Breaking</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">if</span> <span class="n">t_here</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="p">:</span>
                        <span class="n">t_here</span> <span class="o">=</span> <span class="n">time</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B_Breaking</span> <span class="o">=</span> <span class="n">detadt</span> <span class="o">/</span> <span class="n">dzdt_star</span> <span class="o">-</span><span class="mf">1.0</span>
                    <span class="k">if</span> <span class="n">t_here</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                        <span class="n">t_here</span> <span class="o">=</span> <span class="n">time</span>

                <span class="n">nu_breaking</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">B_Breaking</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_breaking</span> <span class="o">*</span> <span class="n">h_here</span> <span class="o">*</span> <span class="n">detadt</span><span class="p">)</span>

                <span class="c1"># Smagorinsky subgrid eddy viscosity</span>
                <span class="n">Smag_cm</span> <span class="o">=</span> <span class="mf">0.04</span>
                <span class="n">nu_Smag</span> <span class="o">=</span> <span class="n">Smag_cm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">*</span> <span class="n">ti</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">dPdx</span> <span class="o">*</span> <span class="n">dPdx</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">dQdy</span> <span class="o">*</span> <span class="n">dQdy</span> <span class="o">+</span> <span class="p">(</span><span class="n">dPdy</span> <span class="o">+</span> <span class="n">dQdx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dPdy</span> <span class="o">+</span> <span class="n">dQdx</span><span class="p">))</span> <span class="o">*</span> <span class="n">divide_by_h</span>  <span class="c1"># temporary, needs to be corrected to strain rate, right now has extra dHdx terms</span>

                <span class="c1"># sum eddy viscosities and calc fluxes</span>
                <span class="n">nu_total</span> <span class="o">=</span> <span class="n">nu_breaking</span> <span class="o">+</span> <span class="n">nu_Smag</span>

                <span class="n">nu_dPdx</span> <span class="o">=</span> <span class="n">nu_total</span> <span class="o">*</span> <span class="n">dPdx</span>
                <span class="n">nu_dPdy</span> <span class="o">=</span> <span class="n">nu_total</span> <span class="o">*</span> <span class="n">dPdy</span>

                <span class="n">nu_dQdx</span> <span class="o">=</span> <span class="n">nu_total</span> <span class="o">*</span> <span class="n">dQdx</span>
                <span class="n">nu_dQdy</span> <span class="o">=</span> <span class="n">nu_total</span> <span class="o">*</span> <span class="n">dQdy</span>

                <span class="n">nu_flux</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">nu_dPdx</span><span class="p">,</span> <span class="n">nu_dPdy</span><span class="p">,</span> <span class="n">nu_dQdx</span><span class="p">,</span> <span class="n">nu_dQdy</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">Bvalues</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">t_here</span><span class="p">,</span> <span class="n">nu_breaking</span><span class="p">,</span> <span class="n">B_Breaking</span><span class="p">,</span> <span class="n">nu_Smag</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">DissipationFlux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu_flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Breaking</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bvalues</span></div>


<div class="viewcode-block" id="Solver.TriDiag_PCRx">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.TriDiag_PCRx">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">TriDiag_PCRx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">s</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">current_buffer</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">(),</span> <span class="n">next_buffer</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parallel Cyclic Reduction step in x-direction for tridiagonal system </span>
<span class="sd">        (Boussinesq dispersion). This kernel performs the p-th level of reduction.</span>

<span class="sd">        Args:</span>
<span class="sd">            p (int): Current level in PCR (log2 scale).</span>
<span class="sd">            s (int): Step size (2^p).</span>
<span class="sd">            current_buffer (ti.field): Current coefficients at p-1 level.</span>
<span class="sd">            next_buffer (ti.field): Next coefficients to be filled for p-th level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">:</span>
            <span class="n">CurrentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">idx_left</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">raw_mod</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">idx_right</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">raw_mod</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>

            <span class="n">aIn</span><span class="p">,</span> <span class="n">bIn</span><span class="p">,</span> <span class="n">cIn</span><span class="p">,</span> <span class="n">dIn</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
            <span class="n">aInLeft</span><span class="p">,</span> <span class="n">bInLeft</span><span class="p">,</span> <span class="n">cInLeft</span><span class="p">,</span> <span class="n">dInLeft</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
            <span class="n">aInRight</span><span class="p">,</span> <span class="n">bInRight</span><span class="p">,</span> <span class="n">cInRight</span><span class="p">,</span> <span class="n">dInRight</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">g</span>
                <span class="n">bInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">idx_left</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">g</span>
                <span class="n">bInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">idx_right</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">g</span>

                <span class="n">aIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">bIn</span>
                <span class="n">aInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">idx_left</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">bInLeft</span>
                <span class="n">aInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">idx_right</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">bInRight</span>

                <span class="n">cIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bIn</span>
                <span class="n">cInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">idx_left</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bInLeft</span>
                <span class="n">cInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMatx</span><span class="p">[</span><span class="n">idx_right</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bInRight</span>

                <span class="n">dIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">bIn</span>
                <span class="n">dInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">idx_left</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="o">/</span> <span class="n">bInLeft</span>
                <span class="n">dInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">idx_right</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">bInRight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aIn</span> <span class="o">=</span><span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aInLeft</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">idx_left</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aInRight</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">idx_right</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">cIn</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">cInLeft</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">idx_left</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">cInRight</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">idx_right</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">dIn</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">dInLeft</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">idx_left</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">dInRight</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">idx_right</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">r</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">aIn</span> <span class="o">*</span> <span class="n">cInLeft</span> <span class="o">-</span> <span class="n">cIn</span> <span class="o">*</span> <span class="n">aInRight</span><span class="p">)</span>
            <span class="n">aOut</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">aIn</span> <span class="o">*</span> <span class="n">aInLeft</span>
            <span class="n">cOut</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">cIn</span> <span class="o">*</span> <span class="n">cInRight</span>
            <span class="n">dOut</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">dIn</span> <span class="o">-</span> <span class="n">aIn</span> <span class="o">*</span> <span class="n">dInLeft</span> <span class="o">-</span> <span class="n">cIn</span> <span class="o">*</span> <span class="n">dInRight</span><span class="p">)</span>

            <span class="n">next_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">aOut</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">cOut</span><span class="p">,</span> <span class="n">dOut</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp2_PCRx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">CurrentState</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">dOut</span><span class="p">,</span> <span class="n">CurrentState</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">CurrentState</span><span class="o">.</span><span class="n">a</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="Solver.TriDiag_PCRy">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.TriDiag_PCRy">[docs]</a>
    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">TriDiag_PCRy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">s</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">current_buffer</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">(),</span> <span class="n">next_buffer</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parallel Cyclic Reduction step in y-direction for tridiagonal system </span>
<span class="sd">        (Boussinesq dispersion).</span>

<span class="sd">        Args:</span>
<span class="sd">            p (int): Current level in PCR (log2 scale).</span>
<span class="sd">            s (int): Step size (2^p).</span>
<span class="sd">            current_buffer (ti.field): Current coefficients at p-1 level.</span>
<span class="sd">            next_buffer (ti.field): Next coefficients for p-th level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">:</span>
            <span class="n">CurrentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">idx_left</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">raw_mod</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">idx_right</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">raw_mod</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>

            <span class="n">aIn</span><span class="p">,</span> <span class="n">bIn</span><span class="p">,</span> <span class="n">cIn</span><span class="p">,</span> <span class="n">dIn</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
            <span class="n">aInLeft</span><span class="p">,</span> <span class="n">bInLeft</span><span class="p">,</span> <span class="n">cInLeft</span><span class="p">,</span> <span class="n">dInLeft</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
            <span class="n">aInRight</span><span class="p">,</span> <span class="n">bInRight</span><span class="p">,</span> <span class="n">cInRight</span><span class="p">,</span> <span class="n">dInRight</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">g</span>
                <span class="n">bInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_left</span><span class="p">]</span><span class="o">.</span><span class="n">g</span>
                <span class="n">bInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_right</span><span class="p">]</span><span class="o">.</span><span class="n">g</span>

                <span class="n">aIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">bIn</span>
                <span class="n">aInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_left</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">bInLeft</span>
                <span class="n">aInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_right</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">bInRight</span>

                <span class="n">cIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bIn</span>
                <span class="n">cInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_left</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bInLeft</span>
                <span class="n">cInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefMaty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_right</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bInRight</span>

                <span class="n">dIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bIn</span>
                <span class="n">dInLeft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_left</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bInLeft</span>
                <span class="n">dInRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_right</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">bInRight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aIn</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aInLeft</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_left</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aInRight</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_right</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">cIn</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">cInLeft</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_left</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">cInRight</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_right</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">dIn</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">dInLeft</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_left</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">dInRight</span> <span class="o">=</span> <span class="n">current_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx_right</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">r</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">aIn</span> <span class="o">*</span> <span class="n">cInLeft</span> <span class="o">-</span> <span class="n">cIn</span> <span class="o">*</span> <span class="n">aInRight</span><span class="p">)</span>
            <span class="n">aOut</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">aIn</span> <span class="o">*</span> <span class="n">aInLeft</span>
            <span class="n">cOut</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">cIn</span> <span class="o">*</span> <span class="n">cInRight</span>
            <span class="n">dOut</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">dIn</span> <span class="o">-</span> <span class="n">aIn</span> <span class="o">*</span> <span class="n">dInLeft</span> <span class="o">-</span> <span class="n">cIn</span> <span class="o">*</span> <span class="n">dInRight</span><span class="p">)</span>

            <span class="n">next_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">aOut</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">cOut</span><span class="p">,</span> <span class="n">dOut</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp2_PCRy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="p">([</span><span class="n">CurrentState</span><span class="o">.</span><span class="n">r</span><span class="p">,</span><span class="n">CurrentState</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">dOut</span><span class="p">,</span> <span class="n">CurrentState</span><span class="o">.</span><span class="n">a</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="Solver.Run_Tridiag_solver">
<a class="viewcode-back" href="../../celeris.html#celeris.solver.Solver.Run_Tridiag_solver">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Run_Tridiag_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the parallel cyclic reduction (PCR) solver to handle the dispersion </span>
<span class="sd">        terms in the Boussinesq model. If model is &#39;SWE&#39;, no action is taken.</span>

<span class="sd">        For 1D (ny=1), only the x-direction solver is applied.  </span>
<span class="sd">        For 2D, runs PCR in x, then y directions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">==</span><span class="s1">&#39;SWE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_states</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_stateUVstar</span><span class="p">,</span><span class="n">dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Px</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TriDiag_PCRx</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">current_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx1</span><span class="p">,</span> <span class="n">next_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TriDiag_PCRx</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">current_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx2</span><span class="p">,</span> <span class="n">next_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_states</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp2_PCRx</span><span class="p">,</span><span class="n">dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Px</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TriDiag_PCRx</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">current_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx1</span><span class="p">,</span> <span class="n">next_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TriDiag_PCRx</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">current_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx2</span><span class="p">,</span> <span class="n">next_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRx1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_states</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp2_PCRx</span><span class="p">,</span><span class="n">dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Py</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">p</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TriDiag_PCRy</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">current_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRy1</span><span class="p">,</span> <span class="n">next_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRy2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TriDiag_PCRy</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">current_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRy2</span><span class="p">,</span> <span class="n">next_buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_PCRy1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_states</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp2_PCRy</span><span class="p">,</span><span class="n">dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">NewState</span><span class="p">)</span></div>


    <span class="c1"># To test pressure</span>
    <span class="c1">#@ti.kernel</span>
    <span class="c1">#def Ship_pressure(self,px_init:int,py_init:int,steps:int):</span>
    <span class="c1">#    pos_x = int(px_init + steps*self.dt)</span>
    <span class="c1">#    pos_y = int(py_init + 0.01*steps*self.dt)</span>
    <span class="c1">#    self.ShipPressure[pos_x,pos_y].x = 2.5</span>


    <span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Update_Bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">ti</span><span class="o">.</span><span class="n">ndrange</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)):</span>
            <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">erosion_Sed</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deposition_Sed</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">delta_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">*</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Bottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="n">delta_B</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solver Module used in Celeris&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lynett Wave Research Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>