

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>celeris.domain &mdash; CelerisAi 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CelerisAi
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Celeris Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CelerisAi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">celeris.domain</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for celeris.domain</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">griddata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">taichi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ti</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">taichi.math</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tm</span>

<span class="c1">#ti.init(arch=ti.cuda)</span>
<div class="viewcode-block" id="checjson">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.checjson">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">checjson</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a key exists in a JSON config file (i.e., CelerisWebGPU configuration file).</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): The key to check in the JSON config file.</span>
<span class="sd">        config (dict): The JSON-loaded dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: 1 if the key is found in the JSON dictionary, 0 otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">R</span></div>


<div class="viewcode-block" id="ti2np">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.ti2np">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ti2np</span><span class="p">(</span><span class="n">ti_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a Taichi precision type to a NumPy dtype.</span>

<span class="sd">    Args:</span>
<span class="sd">        precision (ti.types.primitive_types): Taichi precision type (e.g., ti.f32, ti.f64).</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.dtype: Corresponding NumPy dtype (e.g., np.float32, np.float64).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">if</span> <span class="n">ti_type</span><span class="o">==</span><span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">:</span>
        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">if</span> <span class="n">ti_type</span><span class="o">==</span><span class="n">ti</span><span class="o">.</span><span class="n">f16</span><span class="p">:</span>
        <span class="n">np_type</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span>
    <span class="k">return</span> <span class="n">np_type</span></div>


<div class="viewcode-block" id="Topodata">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Topodata">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Topodata</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages all topography/bathymetry data formats for CelerisAi.</span>

<span class="sd">    This class handles different input formats for bathymetric or topographic data,</span>
<span class="sd">    such as 2D (XYZ), 1D (XZ), and Celeris-native formats. It reads the corresponding</span>
<span class="sd">    files (or folders) and loads them into a NumPy array for further processing or</span>
<span class="sd">    analysis.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        filename (str, optional): Name of the file containing topographic/bathymetric </span>
<span class="sd">            data. If `path` is provided, the file is assumed to be located there.</span>
<span class="sd">        datatype (str, optional): Format of the data. Accepted values are:</span>
<span class="sd">            - &quot;xyz&quot;: 2D data in three columns (x, y, z)</span>
<span class="sd">            - &quot;xz&quot;: 1D data in two columns (x, z)</span>
<span class="sd">            - &quot;celeris&quot;: 2D data located in a folder with a file named &quot;bathy.txt&quot;</span>
<span class="sd">        path (str, optional): Directory path where the file is located. If not provided, </span>
<span class="sd">            `filename` should be a complete path or in the current working directory.</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from celeris.domain import Topodata</span>
<span class="sd">        &gt;&gt;&gt; baty = Topodata(datatype=&#39;celeris&#39;,path=&#39;./examples/DuckFRF_NC&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Topodata object with the necessary parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str, optional): Name of the file containing the data. If `path`</span>
<span class="sd">                is also specified, the file is read from that path. Defaults to None.</span>
<span class="sd">            datatype (str, optional): Specifies the data format. Accepted values are:</span>
<span class="sd">                &quot;xyz&quot;, &quot;xz&quot;, or &quot;celeris&quot;. Defaults to None.</span>
<span class="sd">            path (str, optional): Directory path where the data file is located. </span>
<span class="sd">                Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">datatype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

<div class="viewcode-block" id="Topodata.z">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Topodata.z">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the bathymetry/topography data based on the specified datatype.</span>

<span class="sd">        Depending on the `datatype`, this method reads the corresponding file(s) and </span>
<span class="sd">        returns the data as a NumPy array.</span>

<span class="sd">        - For &quot;xyz&quot;: Expects a file with three columns (x, y, z).</span>
<span class="sd">        - For &quot;xz&quot;: Expects a file with two columns (x, z).</span>
<span class="sd">        - For &quot;celeris&quot;: Expects a folder containing a file named &quot;bathy.txt&quot;. </span>
<span class="sd">          The returned array values are multiplied by -1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray or str: </span>
<span class="sd">                - A NumPy array if `datatype` is recognized and the file is successfully </span>
<span class="sd">                  read. </span>
<span class="sd">                - The string &quot;No supported format&quot; if `datatype` is not recognized.</span>

<span class="sd">        Raises:</span>
<span class="sd">            OSError: If the file (or directory for &quot;celeris&quot;) cannot be found or read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;xz&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;celeris&#39;</span><span class="p">:</span>
                <span class="n">bathy</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;bathy.txt&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">bathy</span><span class="o">*-</span><span class="mi">1</span>
        
        <span class="k">return</span> <span class="s1">&#39;No supported format&#39;</span></div>
</div>



<div class="viewcode-block" id="BoundaryConditions">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.BoundaryConditions">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BoundaryConditions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages boundary conditions for a rectangular domain in the CelerisAi model.</span>

<span class="sd">    The domain has four faces: north, south, east, and west. Each face can be configured</span>
<span class="sd">    with different boundary types (e.g., sponge layer, solid wall, incoming wave).</span>
<span class="sd">    Boundary conditions can be set in one of two ways:</span>

<span class="sd">    1) **Celeris format** (`celeris=True`): Reads from a `config.json` file.</span>
<span class="sd">    2) **Manual** (`celeris=False`): Uses manually supplied values.</span>

<span class="sd">    If incoming waves (boundary type = 2) are defined, the wave type can be specified</span>
<span class="sd">    via `WaveType`. If `WaveType` is -1, the wave parameters are read from a file</span>
<span class="sd">    (e.g., `&quot;waves.txt&quot;`). Otherwise, a sine wave is assumed and set by `sine_wave`.</span>

<span class="sd">    This class also includes utility methods for handling wave data input and </span>
<span class="sd">    conversion from NumPy arrays to Taichi tensors.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        precision (taichi.types.primitive_types): The precision used by Taichi (e.g. `ti.f32`, `ti.f64`).</span>

<span class="sd">        North (int): Boundary type for the north face. Valid types are:</span>

<span class="sd">            - 0: Solid wall</span>
<span class="sd">            - 1: Sponge layer</span>
<span class="sd">            - 2: Incoming wave</span>

<span class="sd">        South (int): Boundary type for the south face.</span>
<span class="sd">        East (int): Boundary type for the east face.</span>
<span class="sd">        West (int): Boundary type for the west face.</span>

<span class="sd">        WaveType (int): Wave type indicator. Valid values are:</span>

<span class="sd">            - -1: Wave parameters read from a file (`waves.txt`)</span>
<span class="sd">            - Any other integer: Use the `sine_wave` array for wave parameters</span>

<span class="sd">        Amplitude (float): Wave amplitude, used if not reading from a file.</span>
<span class="sd">        path (str): Path to the directory containing `waves.txt` and/or `config.json`.</span>
<span class="sd">        filename (str): Name of the file that stores wave parameters (e.g. `waves.txt`).</span>
<span class="sd">        BoundaryWidth (int): Width of the sponge or boundary zone.</span>
<span class="sd">        sine_wave (list of float): Parameters defining a sine wave if `WaveType` is not -1.</span>
<span class="sd">        celeris (bool): If True, boundary conditions are read from `config.json`.</span>
<span class="sd">        configfile (dict, optional): Loaded JSON configuration when `celeris=True`.</span>
<span class="sd">        data (numpy.ndarray): Placeholder array for wave data (size depends on `N_data`).</span>
<span class="sd">        N_data (int): Number of wave entries to read from file.</span>
<span class="sd">        W_data (None): Unused placeholder (could store wave data in some contexts).</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; from celeris.domain import BoundaryConditions</span>
<span class="sd">        &gt;&gt;&gt; bc = BoundaryConditions(celeris=True, path=&#39;./examples/DuckFRF_NC&#39;, precision=precision)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">celeris</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">precision</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">,</span>
                 <span class="n">North</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">South</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">East</span> <span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">West</span> <span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">WaveType</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">Amplitude</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./scratch&#39;</span><span class="p">,</span>
                 <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;waves.txt&#39;</span><span class="p">,</span>
                 <span class="n">BoundaryWidth</span><span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                 <span class="n">init_eta</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">sine_wave</span><span class="o">=</span><span class="kc">None</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the BoundaryConditions object with specified or default parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">        </span>
<span class="sd">            celeris (bool, optional): If True, reads boundary settings from `config.json` </span>
<span class="sd">                located at `path`. Defaults to True.</span>
<span class="sd">            precision (taichi.types.primitive_types, optional): Taichi precision type </span>
<span class="sd">                (e.g., `ti.f32`, `ti.f64`). Defaults to `ti.f32`.</span>
<span class="sd">            North (int, optional): Boundary type for the north face. Defaults to 10 (unrecognized).</span>
<span class="sd">            South (int, optional): Boundary type for the south face. Defaults to 10 (unrecognized).</span>
<span class="sd">            East (int, optional): Boundary type for the east face. Defaults to 10 (unrecognized).</span>
<span class="sd">            West (int, optional): Boundary type for the west face. Defaults to 10 (unrecognized).</span>
<span class="sd">            WaveType (int, optional): Indicator for wave input. Defaults to -1 (read from file).</span>
<span class="sd">            Amplitude (float, optional): Amplitude of the wave if not read from a file. Defaults to 0.5.</span>
<span class="sd">            path (str, optional): Directory path containing `config.json` and/or `waves.txt`. </span>
<span class="sd">                Defaults to &#39;./scratch&#39;.</span>
<span class="sd">            filename (str, optional): Wave file name (e.g. `waves.txt`). Defaults to &#39;waves.txt&#39;.</span>
<span class="sd">            BoundaryWidth (int, optional): Width of the sponge or boundary zone. Defaults to 20.</span>
<span class="sd">            sine_wave (list of float, optional): Parameters defining a sine wave if `WaveType` is not -1.</span>
<span class="sd">                If None, defaults to `[0, 0, 0, 0]`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sine_wave</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sine_wave</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">North</span> <span class="o">=</span> <span class="n">North</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">South</span> <span class="o">=</span> <span class="n">South</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">East</span> <span class="o">=</span> <span class="n">East</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">West</span> <span class="o">=</span> <span class="n">West</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WaveType</span> <span class="o">=</span> <span class="n">WaveType</span> <span class="c1"># -1 to read from a file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sine_wave</span> <span class="o">=</span> <span class="n">sine_wave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_data</span>  <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_data</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_eta</span><span class="o">=</span><span class="n">init_eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span> <span class="o">=</span> <span class="n">Amplitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">celeris</span><span class="o">=</span><span class="n">celeris</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celeris</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;waves.txt&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;config.json&#39;</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">uf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;BoundaryWidth&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BoundaryWidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;BoundaryWidth&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="o">=</span><span class="n">BoundaryWidth</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;north_boundary_type&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">North</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;north_boundary_type&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">North</span> <span class="o">=</span> <span class="n">North</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;south_boundary_type&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">South</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;south_boundary_type&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">South</span> <span class="o">=</span> <span class="n">South</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;east_boundary_type&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">East</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;east_boundary_type&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">East</span> <span class="o">=</span> <span class="n">East</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;west_boundary_type&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">West</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;west_boundary_type&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">West</span> <span class="o">=</span> <span class="n">West</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BoundaryWidth</span><span class="o">=</span><span class="n">BoundaryWidth</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">North</span> <span class="o">=</span> <span class="n">North</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">South</span> <span class="o">=</span> <span class="n">South</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">West</span> <span class="o">=</span> <span class="n">West</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">East</span> <span class="o">=</span> <span class="n">East</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>



<div class="viewcode-block" id="BoundaryConditions.Sponge">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.BoundaryConditions.Sponge">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Sponge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the sponge (boundary) width to be used in the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            width (int, optional): Overrides the class-level sponge width. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The sponge width (either the class attribute or the passed-in argument).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">width</span></div>


<div class="viewcode-block" id="BoundaryConditions.SineWave">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.BoundaryConditions.SineWave">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">SineWave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides the sine wave parameters as a NumPy array of the specified precision.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: An array of length 4 containing the sine wave parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sine_wave</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoundaryConditions.tseries">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.BoundaryConditions.tseries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if a wave parameter file is specified.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if `self.filename` is not None, indicating that time series </span>
<span class="sd">            wave data can be read from a file. Otherwise, False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="BoundaryConditions.load_data">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.BoundaryConditions.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads wave parameters from `waves.txt` if `WaveType` is -1.</span>

<span class="sd">        If a valid file is found, it reads the wave parameters:</span>
<span class="sd">        </span>
<span class="sd">        - The first three lines are header-like info (only the &#39;NumberOfWaves&#39; line is used).</span>
<span class="sd">        - After skipping three lines, wave parameters are loaded. The shape of `self.data`</span>
<span class="sd">          is `(N_data, 4)`, where `N_data` is determined by reading the &#39;NumberOfWaves&#39; </span>
<span class="sd">          line in the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wavefile</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">wavefile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;NumberOfWaves&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">N_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">ti2np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N_data</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">ti2np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_data</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_data</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">temp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ti2np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="BoundaryConditions.get_data">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.BoundaryConditions.get_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures wave data is loaded if reading from a file, then returns a Taichi field.</span>

<span class="sd">        If `WaveType` is -1, calls `load_data()` to populate `self.data` from the file.</span>
<span class="sd">        Converts the resulting NumPy array into a Taichi field and returns it.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ti.field: A Taichi field of shape `(N_data, 4)` containing wave parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">WaveType</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_data</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>
</div>



<div class="viewcode-block" id="Domain">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain">[docs]</a>
<span class="nd">@ti</span><span class="o">.</span><span class="n">data_oriented</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Domain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the numerical domain for wave propagation solver in CelerisAi.</span>

<span class="sd">    This class sets up the domain geometry (x1, x2, y1, y2) and resolution (Nx, Ny), </span>
<span class="sd">    handles bathymetric/topographic data (via an instance of a `Topodata` class), </span>
<span class="sd">    configures boundary sea levels on each face (north, south, east, west), </span>
<span class="sd">    and stores critical parameters such as Courant number (`Courant`), friction, </span>
<span class="sd">    and base depth. Two main branches are supported for configuration:</span>
<span class="sd">    </span>
<span class="sd">        1. **Celeris format**: Reads from a `config.json` file (if `topodata.datatype == &quot;celeris&quot;`).</span>
<span class="sd">        2. **Manual**: Uses provided arguments directly.</span>

<span class="sd">    The class also defines utility methods to:</span>
<span class="sd">    </span>
<span class="sd">        - Create a meshgrid for the domain (`grid`).</span>
<span class="sd">        - Load and interpolate topographic/bathymetric data (`topofield`, `bottom`).</span>
<span class="sd">        - Compute maximum depth (`maxdepth`) and highest topography (`maxtopo`).</span>
<span class="sd">        - Compute the time step (`dt`) based on Courant criteria.</span>
<span class="sd">        - Provide reflection indices for solid boundary conditions (`reflect_x`, `reflect_y`).</span>
<span class="sd">        - Create Taichi field templates for solver states (`states`, `states_one`).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        precision (ti.types.primitive_types): Taichi precision (e.g., `ti.f32`, `ti.f64`).</span>
<span class="sd">        x1 (float): Minimum x-coordinate of the domain.</span>
<span class="sd">        x2 (float): Maximum x-coordinate of the domain.</span>
<span class="sd">        y1 (float): Minimum y-coordinate of the domain.</span>
<span class="sd">        y2 (float): Maximum y-coordinate of the domain.</span>
<span class="sd">        Nx (int): Number of grid cells in the x-direction.</span>
<span class="sd">        Ny (int): Number of grid cells in the y-direction.</span>
<span class="sd">        topodata (Topodata): Instance that handles bathymetry/topography data.</span>
<span class="sd">        north_sl (float): Sea level at the north boundary.</span>
<span class="sd">        south_sl (float): Sea level at the south boundary.</span>
<span class="sd">        east_sl (float): Sea level at the east boundary.</span>
<span class="sd">        west_sl (float): Sea level at the west boundary.</span>
<span class="sd">        Courant (float): Courant number for numerical stability.</span>
<span class="sd">        isManning (int): Switch indicating whether Manning friction is used.</span>
<span class="sd">        friction (float): Friction (e.g., Manning n) value.</span>
<span class="sd">        base_depth_ (float or None): Reference base depth of the domain. </span>
<span class="sd">            If None, it is inferred from the topography.</span>
<span class="sd">        Boundary_shift (int): Shift parameter used for boundary indexing or conditions.</span>
<span class="sd">        pixels (ti.field): Taichi field for potential 2D visualization or debugging (shape = [Nx, Ny]).</span>
<span class="sd">        g (float): Gravitational constant (9.80665).</span>
<span class="sd">        configfile (dict or None): Loaded JSON dictionary if using Celeris format.</span>
<span class="sd">        seaLevel (float): Reference sea level (set to 0.0 here).</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from celeris.domain import Domain,Topodata</span>
<span class="sd">        &gt;&gt;&gt; topo = Topodata(filename=&#39;bathy.txt&#39;, datatype=&#39;xyz&#39;)</span>
<span class="sd">        &gt;&gt;&gt; domain = Domain(x1=0, x2=100, y1=0, y2=100, Nx=100, Ny=100, topodata=topo)</span>
<span class="sd">        &gt;&gt;&gt; xgrid, ygrid, bathy = domain.grid()</span>
<span class="sd">        &gt;&gt;&gt; dt = domain.dt()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Time step: {dt}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">precision</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">f32</span><span class="p">,</span>
                 <span class="n">x1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">x2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">y1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">y2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">Nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">Ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">topodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">north_sl</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="n">south_sl</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="n">east_sl</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="n">west_sl</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="n">Courant</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                 <span class="n">isManning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">friction</span> <span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                 <span class="n">base_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">BoundaryShift</span><span class="o">=</span><span class="mi">4</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Domain object with specified domain parameters and reads from </span>
<span class="sd">        a `config.json` file if the topodata datatype is &#39;celeris&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            precision (ti.types.primitive_types, optional): Taichi precision (e.g. `ti.f32`). </span>
<span class="sd">                Defaults to `ti.f32`.</span>
<span class="sd">            x1 (float, optional): Minimum x-coordinate. Defaults to 0.0.</span>
<span class="sd">            x2 (float, optional): Maximum x-coordinate. Defaults to 0.0.</span>
<span class="sd">            y1 (float, optional): Minimum y-coordinate. Defaults to 0.0.</span>
<span class="sd">            y2 (float, optional): Maximum y-coordinate. Defaults to 0.0.</span>
<span class="sd">            Nx (int, optional): Number of grid cells in x-direction. Defaults to 1.</span>
<span class="sd">            Ny (int, optional): Number of grid cells in y-direction. Defaults to 1.</span>
<span class="sd">            topodata (Topodata, optional): Instance of Topodata class that manages </span>
<span class="sd">                bathymetric/topographic data. Defaults to None.</span>
<span class="sd">            north_sl (float, optional): Sea level at north boundary. Defaults to 0.0.</span>
<span class="sd">            south_sl (float, optional): Sea level at south boundary. Defaults to 0.0.</span>
<span class="sd">            east_sl (float, optional): Sea level at east boundary. Defaults to 0.0.</span>
<span class="sd">            west_sl (float, optional): Sea level at west boundary. Defaults to 0.0.</span>
<span class="sd">            Courant (float, optional): Courant number. Defaults to 0.2.</span>
<span class="sd">            isManning (int, optional): Switch for using Manning friction. Defaults to 0.</span>
<span class="sd">            friction (float, optional): Friction parameter (e.g., Manning n). </span>
<span class="sd">                Defaults to 0.001.</span>
<span class="sd">            base_depth (float, optional): Base depth for the domain; if None, </span>
<span class="sd">                will be inferred from topography. Defaults to None.</span>
<span class="sd">            BoundaryShift (int, optional): Shift value used for boundary conditions. </span>
<span class="sd">                Defaults to 4.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">=</span> <span class="n">Nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">=</span> <span class="n">Ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span> <span class="o">=</span> <span class="n">topodata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">north_sl</span> <span class="o">=</span> <span class="n">north_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">south_sl</span> <span class="o">=</span> <span class="n">south_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">east_sl</span>  <span class="o">=</span> <span class="n">east_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">west_sl</span>  <span class="o">=</span> <span class="n">west_sl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seaLevel</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="mf">9.80665</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Boundary_shift</span><span class="o">=</span><span class="n">BoundaryShift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_depth_</span> <span class="o">=</span> <span class="n">base_depth</span>
        <span class="c1"># When topodata.datatype == &#39;celeris&#39;, read from config.json.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;celeris&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;config.json&#39;</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">uf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;WIDTH&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;WIDTH&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span> <span class="o">=</span> <span class="n">Nx</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;HEIGHT&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">=</span> <span class="n">Ny</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;Courant_num&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Courant</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;Courant_num&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Courant</span> <span class="o">=</span> <span class="n">Courant</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;base_depth&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_depth_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;base_depth&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_depth_</span> <span class="o">=</span> <span class="n">base_depth</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;friction&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;friction&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="n">friction</span>
            <span class="k">if</span> <span class="n">checjson</span><span class="p">(</span><span class="s1">&#39;isManning&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">[</span><span class="s1">&#39;isManning&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span> <span class="o">=</span> <span class="n">isManning</span>
        <span class="c1"># When topodata.datatype == &#39;xyz&#39;, compute dx, dy from domain dimensions.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span> <span class="o">=</span> <span class="n">isManning</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="n">friction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Courant</span> <span class="o">=</span> <span class="n">Courant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_depth_</span> <span class="o">=</span> <span class="n">base_depth</span>
        <span class="c1"># When topodata.datatype == &#39;xz&#39;, treat domain as 1D in x (Ny=1).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;xz&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isManning</span> <span class="o">=</span> <span class="n">isManning</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="n">friction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Courant</span> <span class="o">=</span> <span class="n">Courant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_depth_</span> <span class="o">=</span> <span class="n">base_depth</span>      


        <span class="bp">self</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">))</span>

<div class="viewcode-block" id="Domain.topofield">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.topofield">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">topofield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads and/or interpolates topographic/bathymetric data into a NumPy meshgrid </span>
<span class="sd">        and returns it in a format suitable for use in the solver.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                - **x_out** (numpy.ndarray): Mesh of x-coordinates for the domain.</span>
<span class="sd">                - **y_out** (numpy.ndarray): Mesh of y-coordinates for the domain </span>
<span class="sd">                  (or 1D array if `datatype=&#39;xz&#39;`).</span>
<span class="sd">                - **z_out** (numpy.ndarray): Corresponding bathymetry/topography values.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `topodata.datatype` is not one of &#39;celeris&#39;, &#39;xyz&#39;, or &#39;xz&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;celeris&#39;</span><span class="p">:</span>
            <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">))</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">z</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span><span class="p">,</span><span class="n">foo</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="n">dum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">z</span><span class="p">()</span>  <span class="c1"># shape: (n_points, 3) =&gt; (x, y, z)</span>
            <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">))</span>
            <span class="n">dem</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">dum</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">],</span> <span class="n">dum</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x_out</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y_out</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dem</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;xz&#39;</span><span class="p">:</span>
            <span class="n">dum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">z</span><span class="p">()</span> <span class="c1"># shape: (n_points, 2) =&gt; (x, z)</span>
            <span class="n">x_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
            <span class="n">dem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_out</span><span class="p">,</span><span class="n">dum</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">dum</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">dem</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported topodata datatype.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Domain.bottom">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.bottom">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a 3D NumPy array of shape (4, Nx, Ny) to store bottom elevation </span>
<span class="sd">        (inverted sign), plus any other auxiliary fields (e.g., near-dry flags).</span>

<span class="sd">        Index mapping:</span>
<span class="sd">        </span>
<span class="sd">            - [2, :, :] =&gt; Stores the bathymetry/topography (with a -1 factor).</span>
<span class="sd">            - [3, :, :] =&gt; A placeholder used for near-dry or similar state flags.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ti.field: A Taichi field of shape [4, Nx, Ny] with the bottom information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">ti2np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;xz&#39;</span><span class="p">:</span>
            <span class="c1"># 1D scenario: shape =&gt; topofield()[1] is the array of z-values</span>
            <span class="n">nbottom</span><span class="p">[</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=-</span><span class="mf">1.0</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbottom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=-</span><span class="mf">1.0</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Index 3 is used for near-dry or auxiliary flags.</span>
        <span class="n">nbottom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">99.</span>

        <span class="n">bottom</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,))</span>
        <span class="n">bottom</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">nbottom</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bottom</span></div>


<div class="viewcode-block" id="Domain.grid">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the meshgrid of domain coordinates and corresponding bathymetry/topography.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                - **xx** (numpy.ndarray): x-coordinates (shape: Nx x Ny if 2D; Nx if 1D).</span>
<span class="sd">                - **yy** (numpy.ndarray): y-coordinates (shape: Nx x Ny if 2D; </span>
<span class="sd">                  or topography for 1D).</span>
<span class="sd">                - **zz** (numpy.ndarray): Bathymetry/topography data in 2D case; </span>
<span class="sd">                  None or irrelevant in 1D case (depending on interpretation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">zz</span></div>


<div class="viewcode-block" id="Domain.maxdepth">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.maxdepth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">maxdepth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the maximum depth in the domain. If ``base_depth_`` is specified, </span>
<span class="sd">        returns that. Otherwise:</span>
<span class="sd">        </span>
<span class="sd">            - For 1D (&#39;xz&#39;): returns the maximum of the interpolated topofield array.</span>
<span class="sd">            - For 2D (&#39;xyz&#39;, &#39;celeris&#39;): returns the maximum of topofield array values.</span>

<span class="sd">        Returns:</span>
<span class="sd">        </span>
<span class="sd">            float: Maximum depth (``base_depth_`` if set, else maximum from topofield).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth_</span> <span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 1D domain</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;xz&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># 2D domain</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_depth_</span></div>


<div class="viewcode-block" id="Domain.maxtopo">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.maxtopo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">maxtopo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the highest topographic elevation in the domain. </span>
<span class="sd">        For 1D (&#39;xz&#39;), returns the minimum of the array (assuming negative values </span>
<span class="sd">        represent depth). For 2D, returns the minimum of the topofield array </span>
<span class="sd">        for a similar reason.</span>

<span class="sd">        Returns:</span>
<span class="sd">        </span>
<span class="sd">            float: The highest elevation (or least negative) in the domain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topodata</span><span class="o">.</span><span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;xz&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topofield</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span></div>


<div class="viewcode-block" id="Domain.dt">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.dt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the time step based on the Courant criterion:</span>
<span class="sd">        </span>
<span class="sd">            dt = Courant * dx / sqrt(g * maxdepth)</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The computed time step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maxdepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxdepth</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Courant</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">maxdepth</span><span class="p">())</span></div>


<div class="viewcode-block" id="Domain.reflect_x">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.reflect_x">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reflect_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes an x-reflection index for enforcing solid boundary conditions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The x-reflection index (2*(Nx-3)).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="Domain.reflect_y">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.reflect_y">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reflect_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a y-reflection index for enforcing solid boundary conditions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The y-reflection index (2*(Ny-3)).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="Domain.states">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.states">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Taichi Vector field of shape [Nx, Ny], each containing 4 components </span>
<span class="sd">        (e.g., water depth, momentum in x, momentum in y, and an scalaritional parameter).</span>

<span class="sd">        Returns:</span>
<span class="sd">            ti.types.vector.field: A 4-component vector field in Taichi.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">foo</span></div>


<div class="viewcode-block" id="Domain.states_one">
<a class="viewcode-back" href="../../celeris.html#celeris.domain.Domain.states_one">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">states_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Taichi Vector field of shape [Nx, Ny], each containing 1 component.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ti.types.vector.field: A 1-component vector field in Taichi.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Ny</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">foo</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Domain module used in Celeris&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lynett Wave Research Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>